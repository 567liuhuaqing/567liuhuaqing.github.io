<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content=" Win32 是 Microsoft Windows 操作系统的核心应用程序编程接口（API），用于开发在 Windows 平台上运行的应用程序\nWin32 编码 Win32 字符编码体系\n编码类型 宽字符 (Unicode) 多字节字符 (ANSI) 字符大小 2字节（wchar_t） 1字节（char） 编码标准 UTF-16（小端序） 本地代码页（如GBK, Shift-JIS） API 后缀 W（如 MessageBoxW） A（如 MessageBoxA） 前缀标识 L（如 L&quot;文本&quot;） 无（如 &quot;文本&quot;） 适用场景 现代 Windows 应用（Win2000+） 兼容旧系统（Win9x） 推荐指数 ★★★★★（微软官方推荐） ★☆☆☆☆（已淘汰） 历史演进与技术替代\n">
<title>Win32</title>

<link rel='canonical' href='https://567liuhuaqing.github.io/p/win32/'>

<link rel="stylesheet" href="/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css"><meta property='og:title' content="Win32">
<meta property='og:description' content=" Win32 是 Microsoft Windows 操作系统的核心应用程序编程接口（API），用于开发在 Windows 平台上运行的应用程序\nWin32 编码 Win32 字符编码体系\n编码类型 宽字符 (Unicode) 多字节字符 (ANSI) 字符大小 2字节（wchar_t） 1字节（char） 编码标准 UTF-16（小端序） 本地代码页（如GBK, Shift-JIS） API 后缀 W（如 MessageBoxW） A（如 MessageBoxA） 前缀标识 L（如 L&quot;文本&quot;） 无（如 &quot;文本&quot;） 适用场景 现代 Windows 应用（Win2000+） 兼容旧系统（Win9x） 推荐指数 ★★★★★（微软官方推荐） ★☆☆☆☆（已淘汰） 历史演进与技术替代\n">
<meta property='og:url' content='https://567liuhuaqing.github.io/p/win32/'>
<meta property='og:site_name' content='liuhuaqing'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-07-25T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-07-25T00:00:00&#43;00:00'/><meta property='og:image' content='https://567liuhuaqing.github.io/p/win32/%E8%88%B9%E9%95%BF.jpg' />
<meta name="twitter:title" content="Win32">
<meta name="twitter:description" content=" Win32 是 Microsoft Windows 操作系统的核心应用程序编程接口（API），用于开发在 Windows 平台上运行的应用程序\nWin32 编码 Win32 字符编码体系\n编码类型 宽字符 (Unicode) 多字节字符 (ANSI) 字符大小 2字节（wchar_t） 1字节（char） 编码标准 UTF-16（小端序） 本地代码页（如GBK, Shift-JIS） API 后缀 W（如 MessageBoxW） A（如 MessageBoxA） 前缀标识 L（如 L&quot;文本&quot;） 无（如 &quot;文本&quot;） 适用场景 现代 Windows 应用（Win2000+） 兼容旧系统（Win9x） 推荐指数 ★★★★★（微软官方推荐） ★☆☆☆☆（已淘汰） 历史演进与技术替代\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://567liuhuaqing.github.io/p/win32/%E8%88%B9%E9%95%BF.jpg' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_ebe7edef6fa87d8d.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🌌</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">liuhuaqing</a></h1>
            <h2 class="site-description">lctf{reverse_is_c00l!}</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://www.bilibili.com'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友情链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://567liuhuaqing.github.io/en/" >English</option>
                                
                                    <option value="https://567liuhuaqing.github.io/" selected>简体中文</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#win32-编码">Win32 编码</a>
      <ol>
        <li><a href="#宽字符-unicode">宽字符 Unicode</a>
          <ol>
            <li><a href="#unicode存储的实现方式">Unicode存储的实现方式</a></li>
            <li><a href="#c语言中的宽字符">C语言中的宽字符</a></li>
          </ol>
        </li>
        <li><a href="#win32-api">Win32 API</a>
          <ol>
            <li><a href="#什么是win32-api">什么是Win32 API</a></li>
            <li><a href="#win32-api编码">Win32 API编码</a></li>
            <li><a href="#win32入口程序">Win32入口程序</a></li>
            <li><a href="#win32程序中调试信息">Win32程序中调试信息</a></li>
            <li><a href="#getlasterror的使用">GetLastError的使用</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#win32图形界面">Win32图形界面</a>
      <ol>
        <li><a href="#事件与消息">事件与消息</a></li>
        <li><a href="#win32-gui">Win32 GUI</a>
          <ol>
            <li><a href="#定位回调函数">定位回调函数</a></li>
            <li><a href="#子窗口">子窗口</a></li>
            <li><a href="#资源文件">资源文件</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#win32线程">Win32线程</a>
      <ol>
        <li><a href="#创建线程">创建线程</a>
          <ol>
            <li><a href="#线程控制函数">线程控制函数</a></li>
            <li><a href="#context">CONTEXT</a></li>
          </ol>
        </li>
        <li><a href="#线程互斥与同步">线程互斥与同步</a>
          <ol>
            <li><a href="#线程互斥">线程互斥</a></li>
            <li><a href="#线程同步">线程同步</a></li>
            <li><a href="#互斥与同步对比">互斥与同步对比</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/win32/">
                <img src="/p/win32/%E8%88%B9%E9%95%BF_hu_4506ca195d24d196.jpg"
                        srcset="/p/win32/%E8%88%B9%E9%95%BF_hu_4506ca195d24d196.jpg 800w, /p/win32/%E8%88%B9%E9%95%BF_hu_d35a24ccb61be13b.jpg 1600w"
                        width="800" 
                        height="461" 
                        loading="lazy"
                        alt="Featured image of post Win32" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9%E5%AD%A6%E4%B9%A0/" >
                知识点学习
            </a>
        
            <a href="/categories/reverse/" style="background-color: #2a9d8f; color: #fff;">
                Reverse
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/win32/">Win32</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jul 25, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 37 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <blockquote>
<p><strong>Win32</strong> 是 <strong>Microsoft Windows 操作系统的核心应用程序编程接口（API）</strong>，用于开发在 Windows 平台上运行的应用程序</p></blockquote>
<h2 id="win32-编码">Win32 编码
</h2><blockquote>
<p>Win32 字符编码体系</p></blockquote>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>编码类型</strong></th>
          <th style="text-align: left"><strong>宽字符 (Unicode)</strong></th>
          <th style="text-align: left"><strong>多字节字符 (ANSI)</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>字符大小</strong></td>
          <td style="text-align: left">2字节（wchar_t）</td>
          <td style="text-align: left">1字节（char）</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>编码标准</strong></td>
          <td style="text-align: left">UTF-16（小端序）</td>
          <td style="text-align: left">本地代码页（如GBK, Shift-JIS）</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>API 后缀</strong></td>
          <td style="text-align: left"><code>W</code>（如 <code>MessageBoxW</code>）</td>
          <td style="text-align: left"><code>A</code>（如 <code>MessageBoxA</code>）</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>前缀标识</strong></td>
          <td style="text-align: left"><code>L</code>（如 <code>L&quot;文本&quot;</code>）</td>
          <td style="text-align: left">无（如 <code>&quot;文本&quot;</code>）</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>适用场景</strong></td>
          <td style="text-align: left">现代 Windows 应用（Win2000+）</td>
          <td style="text-align: left">兼容旧系统（Win9x）</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>推荐指数</strong></td>
          <td style="text-align: left">★★★★★（微软官方推荐）</td>
          <td style="text-align: left">★☆☆☆☆（已淘汰）</td>
      </tr>
  </tbody>
</table></div>
<blockquote>
<p>历史演进与技术替代</p></blockquote>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>技术</strong></th>
          <th style="text-align: left"><strong>出现时间</strong></th>
          <th style="text-align: left"><strong>字符编码</strong></th>
          <th style="text-align: left"><strong>现状</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Win16 API</td>
          <td style="text-align: left">1985</td>
          <td style="text-align: left">ANSI</td>
          <td style="text-align: left">完全淘汰</td>
      </tr>
      <tr>
          <td style="text-align: left">Win32 API (A)</td>
          <td style="text-align: left">1993</td>
          <td style="text-align: left">ANSI</td>
          <td style="text-align: left">遗留系统维护</td>
      </tr>
      <tr>
          <td style="text-align: left">Win32 API (W)</td>
          <td style="text-align: left">2000</td>
          <td style="text-align: left">UTF-16</td>
          <td style="text-align: left">主流使用</td>
      </tr>
      <tr>
          <td style="text-align: left">WinRT/UWP</td>
          <td style="text-align: left">2012</td>
          <td style="text-align: left">UTF-16 (兼容UTF-8)</td>
          <td style="text-align: left">新一代应用</td>
      </tr>
  </tbody>
</table></div>
<h3 id="宽字符-unicode">宽字符 Unicode
</h3><blockquote>
<p>Unicode编码创建了一张包含世界上所有文字的编码表，只要世界上存在的文字符号，都会赋予一个唯一的编码。</p>
<p>Unicode编码的范围是：0x0-0x10FFFF，其可以容纳100多万个符号，但是Unicode本身也存在问题，因为Unicode只是一个符号集，它只规定了符号的二进制代码，却没有规定这个二进制代码应该如何去存储。</p></blockquote>
<h4 id="unicode存储的实现方式">Unicode存储的实现方式
</h4><ul>
<li><strong>UTF-8, UTF-16, UTF-32</strong>：它们就是将 Unicode 码点转换成计算机字节序列的具体规则。同一个 Unicode 码点，用这三种编码方式存储，得到的字节序列是不同的。</li>
</ul>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">特性</th>
          <th style="text-align: left">UTF-8</th>
          <th style="text-align: left">UTF-16</th>
          <th style="text-align: left">UTF-32</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>编码单元</strong></td>
          <td style="text-align: left">1 字节 (8位)</td>
          <td style="text-align: left">2 字节 (16位)</td>
          <td style="text-align: left">4 字节 (32位)</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>长度</strong></td>
          <td style="text-align: left"><strong>变长</strong> (1-4字节)</td>
          <td style="text-align: left"><strong>变长</strong> (2或4字节)</td>
          <td style="text-align: left"><strong>定长</strong> (4字节)</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>BOM标记</strong></td>
          <td style="text-align: left">可选 (EF BB BF)</td>
          <td style="text-align: left">必需 (FE FF 或 FF FE)</td>
          <td style="text-align: left">可选 (00 00 FE FF)</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>对ASCII的兼容性</strong></td>
          <td style="text-align: left"><strong>完全兼容</strong></td>
          <td style="text-align: left">不兼容</td>
          <td style="text-align: left">不兼容</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>空间效率</strong></td>
          <td style="text-align: left">对西文最高，对东亚文中等</td>
          <td style="text-align: left">对东亚文最高，对西文中等</td>
          <td style="text-align: left">最低，非常浪费空间</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>处理效率</strong></td>
          <td style="text-align: left">长度不固定，计算字符数和索引较慢</td>
          <td style="text-align: left">多数常用字符定长，处理较快</td>
          <td style="text-align: left">定长，计算字符数和索引最快</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>字节序(Endianness)问题</strong></td>
          <td style="text-align: left"><strong>无</strong></td>
          <td style="text-align: left"><strong>有</strong> (需BOM区分)</td>
          <td style="text-align: left"><strong>有</strong> (需BOM区分)</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>应用场景</strong></td>
          <td style="text-align: left"><strong>互联网、Web、操作系统文件系统</strong></td>
          <td style="text-align: left"><strong>Windows内部、Java、.NET</strong></td>
          <td style="text-align: left">学术研究、内存中临时处理</td>
      </tr>
  </tbody>
</table></div>
<blockquote>
<ol>
<li><strong>UTF-8</strong> (8-bit Unicode Transformation Format)</li>
</ol></blockquote>
<p>这是目前互联网上<strong>使用最广泛</strong>的Unicode编码方式。</p>
<ul>
<li><strong>核心思想：</strong> 用“前缀位”来表示一个字符需要用几个字节。</li>
<li><strong>规则：</strong>
<ul>
<li><strong>单字节</strong>：<code>0xxxxxxx</code>。用于表示所有 <strong>ASCII 字符 (U+0000 到 U+007F)</strong>。这也是它完美兼容ASCII的原因。</li>
<li><strong>双字节</strong>：<code>110xxxxx 10xxxxxx</code>。用于表示一些拉丁文、希腊文等。</li>
<li><strong>三字节</strong>：<code>1110xxxx 10xxxxxx 10xxxxxx</code>。用于表示<strong>绝大多数常用汉字</strong>等中日韩字符。</li>
<li><strong>四字节</strong>：<code>11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</code>。用于表示不常用的字符和<strong>Emoji表情</strong>等。</li>
</ul>
</li>
</ul>
<blockquote>
<ol start="2">
<li><strong>UTF-16</strong> (16-bit Unicode Transformation Format)</li>
</ol></blockquote>
<p>在很多系统内部，尤其是 Windows 和 Java，这是首选的编码方式。</p>
<ul>
<li><strong>核心思想：</strong> 尽量用2个字节表示一个字符，实在不行再用4个。</li>
<li><strong>规则：</strong>
<ul>
<li>对于码点在 <code>U+0000</code> 到 <code>U+FFFF</code> 之间的字符（这个范围包含了几乎所有常用字符，包括大部分汉字），直接用<strong>2个字节</strong>存储。</li>
<li>对于码点超出 <code>U+FFFF</code> 的字符（如Emoji），使用<strong>代理对 (Surrogate Pair)</strong> 的方式，用<strong>4个字节</strong>来表示。</li>
</ul>
</li>
</ul>
<blockquote>
<ol start="3">
<li><strong>UTF-32</strong> (32-bit Unicode Transformation Format)</li>
</ol></blockquote>
<p>最简单直接，但也最浪费空间的编码方式。</p>
<ul>
<li><strong>核心思想：</strong> 不管什么字符，一律用4个字节（32位）来表示。</li>
<li><strong>规则：</strong> 直接将Unicode码点的值用4个字节存储。</li>
</ul>
<h4 id="c语言中的宽字符">C语言中的宽字符
</h4><p>1.宽字符使用</p>
<blockquote>
<p>“中”字编码：</p>
<p>ASCII：<code>d6 d0</code></p>
<p>UNICODE（UTF-16）：<code>4e 2d</code></p></blockquote>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>数据类型</strong></th>
          <th style="text-align: left">宽字符版本</th>
          <th style="text-align: left">多字节版本</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">字符类型</td>
          <td style="text-align: left"><code>wchar_t</code></td>
          <td style="text-align: left"><code>char</code></td>
      </tr>
      <tr>
          <td style="text-align: left">字符串指针</td>
          <td style="text-align: left"><code>LPCWSTR</code> (const wchar_t*)</td>
          <td style="text-align: left"><code>LPCSTR</code> (const char*)</td>
      </tr>
      <tr>
          <td style="text-align: left">可变字符串</td>
          <td style="text-align: left"><code>LPWSTR</code> (wchar_t*)</td>
          <td style="text-align: left"><code>LPSTR</code> (char*)</td>
      </tr>
      <tr>
          <td style="text-align: left">通用字符类型</td>
          <td style="text-align: left"><code>TCHAR</code>（根据配置变化）</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">通用字符串宏</td>
          <td style="text-align: left"><code>LPTSTR</code>, <code>LPCTSTR</code></td>
          <td style="text-align: left"></td>
      </tr>
  </tbody>
</table></div>
<p>字符和字符串</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="sc">&#39;中&#39;</span><span class="p">;</span>	<span class="c1">//使用拓展ASCII编码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">wchar_t</span> <span class="n">x1</span> <span class="o">=</span> <span class="sa">L</span><span class="sc">&#39;中&#39;</span><span class="p">;</span>	<span class="c1">//L指宽字符Unicode编码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">x</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;中国&#34;</span><span class="p">;</span>    <span class="c1">//A
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">wchar_t</span> <span class="n">x1</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;中国&#34;</span><span class="p">;</span>  <span class="c1">//W
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>2.打印宽字符</p>
<p><em>包含头文件</em><code>#include &lt;locale.h&gt;</code></p>
<p><em>主函数中添加</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">setlocale</span><span class="p">(</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>	<span class="c1">//默认本地操作系统地域
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>	<span class="c1">//使用控制台默认编码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">x1</span><span class="p">);</span>	<span class="c1">//默认使用英文，可通过setlocale修改地域
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>3.字符串长度</p>
<p><em>头文件</em><code>#include &lt;string.h&gt;</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">strlen</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>	<span class="c1">//取得多字符编码字符串长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">wcslen</span><span class="p">(</span><span class="n">x1</span><span class="p">);</span>	<span class="c1">//取得宽字符编码字符串长度
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>4.字符串操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">x</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;china&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">x1</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;123&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">strcpy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">wchar_t</span> <span class="n">y</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;中国&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">wchar_t</span> <span class="n">y1</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;好&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">wcscpy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y1</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>还有<code>wcscat</code>、<code>wcscmp</code>、<code>wcsstr</code>等</p>
<h3 id="win32-api">Win32 API
</h3><blockquote>
<p>API（Application Programming Interface，应用程序编程接口）</p></blockquote>
<h4 id="什么是win32-api">什么是Win32 API
</h4><p><strong>Win32 API</strong> 是 <strong>Windows 操作系统底层的应用程序编程接口</strong>，为开发者提供直接访问操作系统核心功能的途径，其主要存放在C:\Windows\System32（存储的DLL是64位）、C:\Windows\SysWOW64（存储的DLL是32位）下面的所有DLL文件（几千个）</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>特性</strong></th>
          <th style="text-align: left"><strong>说明</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>接口类型</strong></td>
          <td style="text-align: left">过程化 C 语言 API（非面向对象）</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>架构层级</strong></td>
          <td style="text-align: left">用户模式与内核模式间的桥梁</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>实现方式</strong></td>
          <td style="text-align: left">通过 DLL 文件暴露函数（如 kernel32.dll, user32.dll）</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>历史地位</strong></td>
          <td style="text-align: left">Windows 95 至今的核心 API（Win64 是其在 64 位系统的扩展）</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>不可替代性</strong></td>
          <td style="text-align: left">所有 Windows 应用框架（.NET/WinUI）最终都调用 Win32 API</td>
      </tr>
  </tbody>
</table></div>
<p><img src="/p/win32/%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E6%9E%B6%E6%9E%84.png"
	width="6148"
	height="1296"
	srcset="/p/win32/%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E6%9E%B6%E6%9E%84_hu_3fc33c84476685ff.png 480w, /p/win32/%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E6%9E%B6%E6%9E%84_hu_b121270f8fdd2504.png 1024w"
	loading="lazy"
	
		alt="Win32 API 核心组件架构"
	
	
		class="gallery-image" 
		data-flex-grow="474"
		data-flex-basis="1138px"
	
></p>
<h5 id="关键功能dll">关键功能DLL
</h5><p>通过这些dll（三环）调用内核函数</p>
<ol>
<li><strong>系统服务</strong>（Kernel32.dll）</li>
</ol>
<ul>
<li>进程/线程：<code>CreateProcess()</code>, <code>CreateThread()</code></li>
<li>内存管理：<code>VirtualAlloc()</code>, <code>HeapAlloc()</code></li>
<li>文件操作：<code>CreateFile()</code>, <code>ReadFile()</code></li>
<li>同步对象：<code>CreateMutex()</code>, <code>WaitForSingleObject()</code></li>
</ul>
<ol start="2">
<li><strong>用户界面</strong>（User32.dll）</li>
</ol>
<ul>
<li>窗口管理：<code>CreateWindowEx()</code>, <code>ShowWindow()</code></li>
<li>消息循环：<code>GetMessage()</code>, <code>DispatchMessage()</code></li>
<li>控件操作：<code>CreateButton()</code>, <code>SetWindowText()</code></li>
<li>资源管理：<code>LoadIcon()</code>, <code>LoadString()</code></li>
</ul>
<ol start="3">
<li><strong>图形设备</strong>（GDI32.dll）</li>
</ol>
<ul>
<li>绘图：<code>LineTo()</code>, <code>Rectangle()</code></li>
<li>文本：<code>TextOut()</code>, <code>DrawText()</code></li>
<li>位图：<code>CreateBitmap()</code>, <code>BitBlt()</code></li>
<li>设备上下文：<code>GetDC()</code>, <code>ReleaseDC()</code></li>
</ul>
<ol start="4">
<li><strong>高级服务</strong></li>
</ol>
<ul>
<li>注册表：<code>RegOpenKeyEx()</code>, <code>RegSetValueEx()</code>（Advapi32.dll）</li>
<li>网络：<code>WSAStartup()</code>, <code>socket()</code>（Ws2_32.dll）</li>
<li>COM 组件：<code>CoInitialize()</code>, <code>CoCreateInstance()</code>（Ole32.dll）</li>
<li>安全：<code>CryptAcquireContext()</code>, <code>CryptEncrypt()</code>（Crypt32.dll）</li>
</ul>
<h4 id="win32-api编码">Win32 API编码
</h4><blockquote>
<p>Windows是使用C语言开发的，<code>Win32 API</code>同时支持宽字符和多字节字符</p>
<p>Windows下所有<strong>内核函数</strong>，涉及字符串均使用宽字节</p></blockquote>
<p>Windows提供的类型如下：（包含头文件<code>Window.h</code>）</p>
<p>1.字符类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">C</span>	<span class="o">--</span> <span class="n">Win32</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">--</span> <span class="n">CHAR</span>	<span class="c1">//F12可跟进查看类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">wchar_t</span> <span class="o">--</span> <span class="n">WCHAR</span>
</span></span><span class="line"><span class="cl"><span class="err">宏</span> <span class="o">--</span> <span class="n">TCHAR</span>	<span class="c1">//若当前项目设置为ASCII编码，则相当于CHAR；若为Unicode编码，则相当于WCHAR，在Win32中推荐使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//用法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">CHAR</span> <span class="n">cha</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;中国&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">WCHAR</span> <span class="n">chw</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;中国&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">TCHAR</span> <span class="n">cht</span><span class="p">[]</span> <span class="o">=</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;中国&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.字符串指针</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">PSTR</span><span class="p">(</span><span class="n">LPSTR</span><span class="p">)</span>	<span class="c1">//指向多字节字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">PWSTR</span><span class="p">(</span><span class="n">LPWSTR</span><span class="p">)</span>	<span class="c1">//指向宽字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">宏</span> <span class="o">--</span> <span class="n">PTSTR</span><span class="p">(</span><span class="n">LPTSTR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//用法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">PSTR</span> <span class="n">pszC</span> <span class="o">=</span> <span class="s">&#34;China&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">PWSTR</span> <span class="n">pszWC</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;china&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">PTSTR</span> <span class="n">pszTC</span> <span class="o">=</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;china&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Windows提供的API，若需要传递字符串参数，都会提供两个版本和一个宏，如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">MessageBoxA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;多字节&#34;</span><span class="p">,</span> <span class="s">&#34;标题&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">MessageBoxW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;宽字符&#34;</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;标题&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">MessageBox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;内容&#34;</span><span class="p">),</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;标题&#34;</span><span class="p">),</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从本质上来讲，Windows字符串都是宽字符的，所以<strong>使用MessageBoxW这种方式性能会更好一些</strong>，因为当你使用<code>MessageBoxA</code>的时候，在到内核的时候（系统底层）其会转化Unicode，弹窗调用如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">WCHAR</span> <span class="n">strTitle</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;Title&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">WCHAR</span> <span class="n">strContent</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;Hello World!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">MessageBoxW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">strContent</span><span class="p">,</span> <span class="n">strTitle</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="win32入口程序">Win32入口程序
</h4><p>VS创建项目<strong>Windows桌面应用程序</strong></p>
<blockquote>
<p><code>wWinMain</code> 是 <strong>Windows 图形用户界面（GUI）应用程序的入口点</strong>，它相当于 C/C++ 控制台程序中的 <code>main</code> 函数</p></blockquote>
<p>当你在 Windows 系统上双击一个 <code>.exe</code> 文件的图标时，操作系统加载完程序后，第一个调用的就是这个函数（或者它的非宽字符版本 <code>WinMain</code>），<strong>函数签名</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">APIENTRY</span> <span class="n">wWinMain</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_</span>     <span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_opt_</span> <span class="n">HINSTANCE</span> <span class="n">hPrevInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_</span>     <span class="n">LPWSTR</span>    <span class="n">lpCmdLine</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_</span>     <span class="kt">int</span>       <span class="n">nCmdShow</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<ul>
<li><strong><code>APIENTRY</code></strong>: 这是一个宏，通常被定义为 <code>__stdcall</code>，这是所有标准 Win32 API 函数使用的约定，所以你的入口点也必须遵守</li>
</ul></blockquote>
<ul>
<li><code>wWinMain</code>:“Windows Main Function”
<ul>
<li>前缀 <strong><code>w</code></strong> 代表 <strong>Wide-character（宽字符）</strong>，这意味着这个版本的入口点接收的是**宽字符（UTF-16）**格式的命令行参数。与之对应的是 <code>WinMain</code>（没有<code>w</code>），它接收的是 ANSI（多字节）字符</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><code>HINSTANCE</code>: Handle to an Instance（实例句柄）
<ul>
<li><strong>句柄 (Handle)</strong>：在Windows中，句柄是一个唯一的数字，它代表了操作系统管理的某个资源（如窗口、文件、进程等）</li>
<li><strong>实例句柄 (Instance Handle)</strong>：<code>hInstance</code> 是一个指向你程序被加载到内存中的那个<strong>模块 (module)</strong> 的句柄，通常，一个 <code>.exe</code> 文件就是一个模块。这个句柄非常重要，因为操作系统用它来唯一标识你的应用程序实例。</li>
<li><strong>用途</strong>：你会在很多后续的 Win32 API 调用中用到它，比如加载图标、光标、字符串资源，或者创建窗口时告诉系统这个窗口属于哪个程序实例。</li>
</ul>
</li>
</ul></blockquote>
<ul>
<li><code>HINSTANCE hPrevInstance</code>: Handle to a Previous Instance（前一个实例的句柄）。
<ul>
<li><strong>历史遗留物</strong>：在古老的16位Windows时代，这个参数用来判断是否已经有同一个程序的实例在运行。如果有，<code>hPrevInstance</code> 会是一个有效值。</li>
<li><strong>在现代32位和64位Windows中，这个参数永远是 <code>NULL</code> (0)</strong>。因为现代操作系统为每个程序提供了独立的地址空间，一个程序无法轻易地知道另一个实例的存在。如果你需要实现“单实例”应用程序（即只允许程序运行一个），你需要使用其他更现代的方法，比如<strong>互斥体 (Mutex)</strong>。</li>
<li><strong>结论</strong>：你可以<strong>完全忽略</strong>这个参数。</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><code>lpCmdLine</code>: 这个参数包含了传递给程序的<strong>命令行参数</strong>
<ul>
<li>例如，如果你在命令行中运行 <code>my_program.exe /config &quot;settings.xml&quot; -debug</code>，那么 <code>lpCmdLine</code> 指向的字符串就是 <code>&quot;/config \&quot;settings.xml\&quot; -debug&quot;</code>。</li>
<li><strong>注意</strong>：它不包含程序本身的名称。如果你需要获取程序自己的路径，应该使用 <code>GetModuleFileName</code> 函数。</li>
</ul>
</li>
</ul></blockquote>
<ul>
<li><code>int nCmdShow</code>: 这个参数是一个整数，指定了程序的主窗口应该以<strong>何种状态显示</strong>
<ul>
<li>这个值是由启动你的程序的那个进程（比如 Windows 资源管理器）传递过来的。</li>
<li>常见的值：
<ul>
<li><code>SW_SHOWNORMAL</code>: 正常显示窗口（不最大化也不最小化）。</li>
<li><code>SW_SHOWMAXIMIZED</code>: 最大化显示。</li>
<li><code>SW_SHOWMINIMIZED</code>: 最小化到任务栏。</li>
</ul>
</li>
<li><strong>如何使用</strong>：在你创建完主窗口后，你应该将这个 <code>nCmdShow</code> 值传递给 <code>ShowWindow</code> 函数，作为它的第二个参数。这是为了尊重启动者的意图。例如，如果用户在另一个程序的快捷方式属性里设置了“以最大化方式运行”，那么操作系统就会通过 <code>nCmdShow</code> 告诉你应该这么做。</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong><code>wWinMain</code> 的典型结构</strong></p>
<p>一个经典的 <code>wWinMain</code> 函数内部通常会做以下几件事：</p>
<ol>
<li><strong>注册窗口类 (Register Window Class)</strong>：使用 <code>WNDCLASSEX</code> 结构体定义窗口的各种属性（如窗口过程函数、图标、光标、背景颜色等），然后调用 <code>RegisterClassEx</code> 告诉操作系统“我要创建一种这样的窗口”。</li>
<li><strong>创建窗口 (Create Window)</strong>：调用 <code>CreateWindowEx</code> 函数，使用上一步注册的窗口类来创建一个具体的窗口实例。</li>
<li><strong>显示和更新窗口 (Show and Update Window)</strong>：调用 <code>ShowWindow</code>（并传入 <code>nCmdShow</code>）和 <code>UpdateWindow</code>，让窗口显示在屏幕上并绘制其内容。</li>
<li>进入消息循环 (Message Loop)：
<ul>
<li>这是一个 <code>while</code> 循环，不断调用 <code>GetMessage</code> 从程序的消息队列中获取消息（如鼠标点击、键盘按键、窗口重绘请求等）。</li>
<li>调用 <code>TranslateMessage</code> 进行一些键盘消息的转换。</li>
<li>调用 <code>DispatchMessage</code> 将消息分发给对应的窗口过程函数（WndProc）去处理。</li>
</ul>
</li>
<li><strong>循环结束，返回</strong>：当 <code>GetMessage</code> 收到 <code>WM_QUIT</code> 消息时，它会返回 <code>FALSE</code>，循环结束，<code>wWinMain</code> 函数返回，程序退出。</li>
</ol></blockquote>
<h5 id="定位入口程序">定位入口程序
</h5><p>这里以win32程序（Debug x86）为例，F8步进，运行到图片光标处，F7步入</p>
<p><img src="/p/win32/F701.png"
	width="2118"
	height="976"
	srcset="/p/win32/F701_hu_64fac9840f3caed7.png 480w, /p/win32/F701_hu_9148495a32934d88.png 1024w"
	loading="lazy"
	
		alt="F701"
	
	
		class="gallery-image" 
		data-flex-grow="217"
		data-flex-basis="520px"
	
></p>
<p><img src="/p/win32/F702.png"
	width="2118"
	height="976"
	srcset="/p/win32/F702_hu_b1e50e112c631748.png 480w, /p/win32/F702_hu_f2581ac0315f025b.png 1024w"
	loading="lazy"
	
		alt="F702"
	
	
		class="gallery-image" 
		data-flex-grow="217"
		data-flex-basis="520px"
	
></p>
<p>此为真正入口函数，可看到push了4个参数</p>
<p><img src="/p/win32/F703.png"
	width="2118"
	height="976"
	srcset="/p/win32/F703_hu_c555c89c1b7c21db.png 480w, /p/win32/F703_hu_3f5d09441740afe1.png 1024w"
	loading="lazy"
	
		alt="F703"
	
	
		class="gallery-image" 
		data-flex-grow="217"
		data-flex-basis="520px"
	
></p>
<p>F7步入，观察函数调用压栈后的堆栈，如图<code>0x010FF6F0</code>内容为函数返回地址，而后<code>F6F4~F700</code>内容分别为WinMain的四个参数：<strong>句柄</strong>、NULL、命令行参数地址、以<strong>何种状态显示</strong></p>
<p><img src="/p/win32/%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0%E5%A0%86%E6%A0%88.png"
	width="2877"
	height="1622"
	srcset="/p/win32/%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0%E5%A0%86%E6%A0%88_hu_eaf6c00eef6d1730.png 480w, /p/win32/%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0%E5%A0%86%E6%A0%88_hu_888952c95db5bd69.png 1024w"
	loading="lazy"
	
		alt="入口函数堆栈"
	
	
		class="gallery-image" 
		data-flex-grow="177"
		data-flex-basis="425px"
	
></p>
<h5 id="esp寻址">ESP寻址
</h5><p>这里以Release版为例（Debug版的太丑了，看不到esp）</p>
<p><img src="/p/win32/%E6%8F%90%E5%8D%87%E5%A0%86%E6%A0%88.png"
	width="2876"
	height="1612"
	srcset="/p/win32/%E6%8F%90%E5%8D%87%E5%A0%86%E6%A0%88_hu_4c61c6f7227c73ac.png 480w, /p/win32/%E6%8F%90%E5%8D%87%E5%A0%86%E6%A0%88_hu_473312a57e0893e8.png 1024w"
	loading="lazy"
	
		alt="提升堆栈"
	
	
		class="gallery-image" 
		data-flex-grow="178"
		data-flex-basis="428px"
	
></p>
<p>返回地址<code>[esp+80]</code>、第一个参数<code>[esp+84]</code>？不错，我们可以双击堆栈中esp的值，这样就可以自动定位啦</p>
<p><img src="/p/win32/esp%E5%AE%9A%E4%BD%8D%E5%B7%A5%E5%85%B7.png"
	width="2876"
	height="1531"
	srcset="/p/win32/esp%E5%AE%9A%E4%BD%8D%E5%B7%A5%E5%85%B7_hu_bc90569d4e9a935a.png 480w, /p/win32/esp%E5%AE%9A%E4%BD%8D%E5%B7%A5%E5%85%B7_hu_a6447bf9f9247673.png 1024w"
	loading="lazy"
	
		alt="esp定位工具"
	
	
		class="gallery-image" 
		data-flex-grow="187"
		data-flex-basis="450px"
	
></p>
<p>找到刚刚返回地址，验证成功</p>
<p><img src="/p/win32/esp%E5%AF%BB%E5%9D%80.png"
	width="1620"
	height="388"
	srcset="/p/win32/esp%E5%AF%BB%E5%9D%80_hu_61556b8f53e4bf15.png 480w, /p/win32/esp%E5%AF%BB%E5%9D%80_hu_91b1531ec900ed2c.png 1024w"
	loading="lazy"
	
		alt="esp寻址"
	
	
		class="gallery-image" 
		data-flex-grow="417"
		data-flex-basis="1002px"
	
></p>
<p>麻烦的是，随着程序的运行，esp的值很可能会改变，这时这个自动定位的用处就大大体现出，想要得到esp定位的真正值，还得运行到要定位的语句才行</p>
<h4 id="win32程序中调试信息">Win32程序中调试信息
</h4><p>简单模板</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 使用 OutputDebugString 输出调试信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">PrintDebugMessage</span><span class="p">(</span><span class="n">LPCWSTR</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">OutputDebugString</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>  <span class="c1">// 在调试器输出窗口显示
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// OutputDebugString(L&#34;Debug message\n&#34;); // 示例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 带格式化输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">PrintDebugFormat</span><span class="p">(</span><span class="n">LPCWSTR</span> <span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">wchar_t</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">vswprintf_s</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">OutputDebugString</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 使用示例：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">PrintDebugFormat</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;鼠标位置: X=%d, Y=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">xPos</span><span class="p">,</span> <span class="n">yPos</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>安全模板</p>
<p><code>outputstr.h</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cstdarg&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">outputStringF</span><span class="p">(</span><span class="n">_In_z_</span> <span class="n">_Printf_format_string_</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">outputStringWF</span><span class="p">(</span><span class="n">_In_z_</span> <span class="n">_Printf_format_string_</span> <span class="k">const</span> <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>output.cpp</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;outputstr.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">outputStringF</span><span class="p">(</span><span class="n">_In_z_</span> <span class="n">_Printf_format_string_</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 使用栈内存避免分配开销（小消息更高效）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="n">stackBuffer</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">dynamicBuffer</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">bufferPtr</span> <span class="o">=</span> <span class="n">stackBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">size_t</span> <span class="n">maxSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stackBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 尝试在栈缓冲区格式化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">_vsnprintf_s</span><span class="p">(</span><span class="n">stackBuffer</span><span class="p">,</span> <span class="n">maxSize</span><span class="p">,</span> <span class="n">_TRUNCATE</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 若栈空间不足，动态分配内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取实际需要的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">result</span> <span class="o">=</span> <span class="n">_vscprintf</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">OutputDebugStringA</span><span class="p">(</span><span class="s">&#34;outputStringF: format error</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">size_t</span> <span class="n">neededSize</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// +换行符+空终止
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">dynamicBuffer</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">(</span><span class="n">neededSize</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dynamicBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">OutputDebugStringA</span><span class="p">(</span><span class="s">&#34;outputStringF: memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_vsnprintf_s</span><span class="p">(</span><span class="n">dynamicBuffer</span><span class="p">,</span> <span class="n">neededSize</span><span class="p">,</span> <span class="n">_TRUNCATE</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufferPtr</span> <span class="o">=</span> <span class="n">dynamicBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 确保添加换行符（安全版）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">bufferPtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">maxSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufferPtr</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufferPtr</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 若已满则替换最后一个字符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">bufferPtr</span><span class="p">[</span><span class="n">maxSize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufferPtr</span><span class="p">[</span><span class="n">maxSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">OutputDebugStringA</span><span class="p">(</span><span class="n">bufferPtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dynamicBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">free</span><span class="p">(</span><span class="n">dynamicBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">outputStringWF</span><span class="p">(</span><span class="n">_In_z_</span> <span class="n">_Printf_format_string_</span> <span class="k">const</span> <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">wchar_t</span> <span class="n">stackBuffer</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">dynamicBuffer</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">bufferPtr</span> <span class="o">=</span> <span class="n">stackBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">size_t</span> <span class="n">maxSize</span> <span class="o">=</span> <span class="n">_countof</span><span class="p">(</span><span class="n">stackBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">_vsnwprintf_s</span><span class="p">(</span><span class="n">stackBuffer</span><span class="p">,</span> <span class="n">maxSize</span><span class="p">,</span> <span class="n">_TRUNCATE</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">_vscwprintf</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">OutputDebugStringW</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;outputStringWF: format error</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">size_t</span> <span class="n">neededSize</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dynamicBuffer</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">(</span><span class="n">neededSize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">wchar_t</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dynamicBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">OutputDebugStringW</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;outputStringWF: memory allocation failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_vsnwprintf_s</span><span class="p">(</span><span class="n">dynamicBuffer</span><span class="p">,</span> <span class="n">neededSize</span><span class="p">,</span> <span class="n">_TRUNCATE</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufferPtr</span> <span class="o">=</span> <span class="n">dynamicBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">bufferPtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">maxSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufferPtr</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sa">L</span><span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufferPtr</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">L</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufferPtr</span><span class="p">[</span><span class="n">maxSize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sa">L</span><span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bufferPtr</span><span class="p">[</span><span class="n">maxSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">L</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">OutputDebugStringW</span><span class="p">(</span><span class="n">bufferPtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dynamicBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">free</span><span class="p">(</span><span class="n">dynamicBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">outputStringF</span><span class="p">(</span><span class="s">&#34;Debug message2, %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wndclass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">outputStringWF</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;Debug message, %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wndclass</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="getlasterror的使用">GetLastError的使用
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">MessageBox</span><span class="p">((</span><span class="n">HWND</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">erro</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">();</span>	<span class="c1">//将改代码放在错误语句的后面，在其后设置断点，F5运行到断点，鼠标放在erro上查看错误值
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>VS提供错误查找工具</p>
<p><img src="/p/win32/%E9%94%99%E8%AF%AF%E6%9F%A5%E6%89%BE.png"
	width="1660"
	height="902"
	srcset="/p/win32/%E9%94%99%E8%AF%AF%E6%9F%A5%E6%89%BE_hu_fc4c909a7fce596a.png 480w, /p/win32/%E9%94%99%E8%AF%AF%E6%9F%A5%E6%89%BE_hu_7a599fd79cf9b0b.png 1024w"
	loading="lazy"
	
		alt="错误查找"
	
	
		class="gallery-image" 
		data-flex-grow="184"
		data-flex-basis="441px"
	
></p>
<p>输入刚刚的错误值查看错误信息</p>
<p><img src="/p/win32/%E9%94%99%E8%AF%AF-1400.png"
	width="562"
	height="333"
	srcset="/p/win32/%E9%94%99%E8%AF%AF-1400_hu_d968f3e6026d6d40.png 480w, /p/win32/%E9%94%99%E8%AF%AF-1400_hu_6f1543f663920f64.png 1024w"
	loading="lazy"
	
		alt="错误-1400"
	
	
		class="gallery-image" 
		data-flex-grow="168"
		data-flex-basis="405px"
	
></p>
<h2 id="win32图形界面">Win32图形界面
</h2><h3 id="事件与消息">事件与消息
</h3><blockquote>
<p>在 Windows 中，<strong>事件 (Event Object)</strong> 是一种<strong>内核对象 (Kernel Object)</strong>，它与进程、线程、互斥体 (Mutex)、信号量 (Semaphore) 处于同一层面</p></blockquote>
<p><strong>事件特征：</strong></p>
<ol>
<li><strong>用途</strong>：主要用于<strong>线程间的同步（Synchronization）</strong>。一个线程可以等待一个事件，而另一个线程可以触发这个事件，从而唤醒等待的线程。</li>
<li><strong>状态</strong>：事件只有两种状态——<strong>已触发 (Signaled)</strong> 和 <strong>未触发 (Non-signaled)</strong>。</li>
<li><strong>类型</strong>：
<ul>
<li><strong>手动重置事件 (Manual-reset Event)</strong>：一旦被触发，它会一直保持“已触发”状态，直到有代码明确地调用 <code>ResetEvent</code> 函数将其重置为“未触发”。它可以同时唤醒所有正在等待它的线程。</li>
<li><strong>自动重置事件 (Auto-reset Event)</strong>：一旦被触发并成功唤醒一个等待的线程后，它会自动变回“未触发”状态。就像一个只能一个人通过的旋转门。</li>
</ul>
</li>
<li><strong>操作函数</strong>：<code>CreateEvent</code>, <code>SetEvent</code> (触发), <code>ResetEvent</code> (重置), <code>WaitForSingleObject</code>, <code>WaitForMultipleObjects</code> (等待)。</li>
<li><strong>可见性</strong>：可以是匿名的（只在当前进程内可见），也可以是命名的（可以跨进程共享和访问）</li>
</ol>
<blockquote>
<p>在 Windows 中，<strong>消息 (Message)</strong> 是 <strong>GUI 子系统（USER32）</strong> 用来与应用程序窗口进行通信的<strong>数据结构</strong>，它驱动着整个 Windows 用户界面的交互</p></blockquote>
<p><strong>消息特征：</strong></p>
<ol>
<li><strong>用途</strong>：用于<strong>通知应用程序发生了某个“有趣的事情”</strong>。这些事情大多与用户输入或窗口状态变化有关。</li>
<li><strong>结构</strong>：一个消息通常是一个<code>MSG</code>结构体，包含以下关键信息：
<ul>
<li><code>hwnd</code>: 消息的目标<strong>窗口句柄</strong>。</li>
<li><code>message</code>: 消息的<strong>类型</strong>（一个唯一的ID，如 <code>WM_KEYDOWN</code>, <code>WM_LBUTTONDOWN</code>, <code>WM_PAINT</code>）。</li>
<li><code>wParam</code>: 附加信息1（具体含义取决于消息类型）。</li>
<li><code>lParam</code>: 附加信息2（具体含义取决于消息类型）。</li>
</ul>
</li>
<li><strong>来源</strong>：
<ul>
<li><strong>硬件输入</strong>：鼠标移动、点击，键盘按下等。操作系统捕获硬件中断，将其转化为消息。</li>
<li><strong>系统通知</strong>：窗口需要重绘 (<code>WM_PAINT</code>)，窗口被销毁 (<code>WM_DESTROY</code>)。</li>
<li><strong>程序内部</strong>：程序可以自己给自己或其他窗口发送/投递消息（使用 <code>SendMessage</code> 或 <code>PostMessage</code>）。</li>
</ul>
</li>
<li>处理流程 (消息循环)：
<ul>
<li>操作系统将消息放入对应线程的<strong>消息队列 (Message Queue)</strong> 中。</li>
<li>应用程序的<strong>消息循环 (<code>while (GetMessage(...))</code>)</strong> 从队列中取出消息。</li>
<li><code>DispatchMessage</code> 将消息派发给目标窗口的<strong>窗口过程函数 (WndProc)</strong>。</li>
<li><code>WndProc</code> 根据消息类型执行相应的处理代码</li>
</ul>
</li>
</ol>
<p><strong>两者对比</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">特性</th>
          <th style="text-align: left">事件 (Event)</th>
          <th style="text-align: left">消息 (Message)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>层面</strong></td>
          <td style="text-align: left"><strong>内核层 (Kernel)</strong></td>
          <td style="text-align: left"><strong>GUI/用户层 (USER32)</strong></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>本质</strong></td>
          <td style="text-align: left"><strong>同步对象 (Synchronization Object)</strong></td>
          <td style="text-align: left"><strong>数据结构 (Data Structure)</strong></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>目的</strong></td>
          <td style="text-align: left"><strong>线程间同步</strong>，协调执行顺序</td>
          <td style="text-align: left"><strong>通知窗口发生了某事</strong>，驱动UI响应</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>状态/内容</strong></td>
          <td style="text-align: left">只有两种状态：<strong>已触发/未触发</strong></td>
          <td style="text-align: left">包含丰富信息：<strong>目标窗口、类型、参数</strong></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>通信方</strong></td>
          <td style="text-align: left"><strong>线程 vs 线程</strong> (或 进程 vs 进程)</td>
          <td style="text-align: left"><strong>系统/用户 vs 窗口</strong> (或 窗口 vs 窗口)</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>处理方式</strong></td>
          <td style="text-align: left">线程通过 <code>WaitFor...</code> <strong>等待</strong>，然后继续执行</td>
          <td style="text-align: left">窗口的 <code>WndProc</code> <strong>被动接收</strong>并处理</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>典型例子</strong></td>
          <td style="text-align: left">一个线程完成下载后，触发一个事件，通知主线程可以更新UI了</td>
          <td style="text-align: left">用户点击鼠标，系统向窗口发送 <code>WM_LBUTTONDOWN</code> 消息</td>
      </tr>
  </tbody>
</table></div>
<p><code>MSG</code><strong>结构体</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tagMAG</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HWND</span> <span class="n">hwnd</span><span class="p">;</span>	<span class="c1">//窗口句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UNIT</span> <span class="n">message</span><span class="p">;</span>	<span class="c1">//消息类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">time</span><span class="p">;</span>	<span class="c1">//事件什么时候发生
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">POINT</span> <span class="n">pt</span><span class="p">;</span>	<span class="c1">//坐标（鼠标位置）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">MSG</span><span class="p">,</span> <span class="o">*</span><span class="n">PMSG</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>消息类型</strong></p>
<blockquote>
<p>首先，Windows 消息都以 <code>WM_</code>（Window Message）为前缀，这使得它们非常容易辨认。比如 <code>WM_CREATE</code>, <code>WM_PAINT</code>, <code>WM_KEYDOWN</code></p></blockquote>
<ol>
<li>窗口管理消息 (Window Management Messages)</li>
<li>用户输入消息 (User Input Messages)</li>
<li>键盘消息</li>
<li>鼠标消息</li>
<li>绘图消息 (Painting Messages)</li>
<li>控件通知消息 (Control Notification Messages)</li>
<li>用户自定义消息 (User-Defined Messages)</li>
<li>剪贴板消息 (Clipboard Messages)</li>
</ol>
<p><strong>Windows 系统消息队列与应用程序消息队列</strong>：事件触发 -&gt; MSG -&gt;系统消息队列 -&gt; 应用消息队列 -&gt; 消息循环 -&gt; 处理消息</p>
<p><img src="/p/win32/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97.png"
	width="1930"
	height="1340"
	srcset="/p/win32/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97_hu_db3d31d0dddb2857.png 480w, /p/win32/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97_hu_422e9d3d86d1bfb5.png 1024w"
	loading="lazy"
	
		alt="消息队列"
	
	
		class="gallery-image" 
		data-flex-grow="144"
		data-flex-basis="345px"
	
></p>
<h3 id="win32-gui">Win32 GUI
</h3><blockquote>
<p>Java GUI 编程和 Win32 GUI 编程在<strong>最终目标</strong>（创建图形用户界面）上是相似的，但在<strong>实现方式、抽象层次、开发体验、跨平台性和底层机制</strong>上存在<strong>巨大差异</strong>，可以说是两种截然不同的范式</p></blockquote>
<ol>
<li><strong>抽象层次与直接性：</strong>
<ul>
<li>
<blockquote>
<p><strong>Win32 GUI：</strong> <strong>极其底层</strong>。开发者直接调用 Windows 操作系统提供的原生 API（主要是 <code>user32.dll</code> 和 <code>gdi32.dll</code>）。你需要：</p>
<ul>
<li>手动注册窗口类 (<code>RegisterClassEx</code>)。</li>
<li>手动创建窗口 (<code>CreateWindowEx</code>)。</li>
<li>编写庞大的消息循环 (<code>GetMessage</code>, <code>TranslateMessage</code>, <code>DispatchMessage</code>)。</li>
<li>在复杂的窗口过程 (<code>WndProc</code>) 函数中处理大量的 Windows 消息 (<code>WM_CREATE</code>, <code>WM_PAINT</code>, <code>WM_COMMAND</code>, <code>WM_SIZE</code>, <code>WM_DESTROY</code> 等)。</li>
<li>直接管理窗口句柄 (<code>HWND</code>)、设备上下文 (<code>HDC</code>)、画笔 (<code>HPEN</code>)、画刷 (<code>HBRUSH</code>) 等底层资源。</li>
<li>显式处理资源释放和内存管理。</li>
</ul></blockquote>
</li>
<li><strong>Java GUI (Swing/JavaFX)：</strong> <strong>高度抽象</strong>。开发者使用 Java 提供的 <strong>GUI 工具包</strong>：
<ul>
<li><strong>Swing：</strong> 基于 AWT，提供了一套纯 Java 实现的、可插拔外观的组件 (<code>JFrame</code>, <code>JButton</code>, <code>JTextField</code>, <code>JTable</code> 等)。开发者主要操作对象 (<code>JButton btn = new JButton(&quot;Click Me&quot;)</code>) 和事件监听器 (<code>btn.addActionListener(...)</code>)。Swing 内部处理了与原生系统的交互。</li>
<li><strong>JavaFX：</strong> 更现代、功能更强大的 GUI 工具包，同样基于对象 (<code>Stage</code>, <code>Scene</code>, <code>Button</code>, <code>TextField</code>, <code>TableView</code> 等)。它使用场景图 (Scene Graph) 模型、CSS 样式、FXML 声明式布局、丰富的图形/媒体/3D 支持，以及绑定 (Binding) 等高级特性。开发者主要关注业务逻辑和界面描述，底层渲染细节由 JavaFX 引擎处理（可以使用硬件加速）。</li>
</ul>
</li>
</ul>
</li>
<li><strong>事件处理模型：</strong>
<ul>
<li>
<blockquote>
<p><strong>Win32 GUI：</strong> <strong>基于消息传递</strong>。所有用户交互（点击、按键、移动鼠标、重绘请求）都转化为特定的 <code>WM_*</code> 消息，被投递到应用程序的消息队列中。你的窗口过程 (<code>WndProc</code>) 必须检查每条消息 (<code>msg.message</code>)，使用巨大的 <code>switch-case</code> 或 <code>if-else</code> 结构来处理它们。处理逻辑与窗口创建代码紧密耦合。</p></blockquote>
</li>
<li><strong>Java GUI (Swing/JavaFX)：</strong> <strong>基于事件监听/回调</strong>。采用 <strong>观察者模式</strong>。
<ul>
<li>你为特定的 UI 组件 (<code>Button</code>, <code>TextField</code>) 注册事件监听器 (<code>ActionListener</code>, <code>MouseListener</code>, <code>KeyListener</code>, <code>ChangeListener</code> 等)。</li>
<li>当用户与组件交互时（如点击按钮），组件会<strong>触发</strong>一个事件对象 (<code>ActionEvent</code>, <code>MouseEvent</code>)。</li>
<li>你注册的监听器方法 (<code>actionPerformed(ActionEvent e)</code>, <code>mouseClicked(MouseEvent e)</code>) 会被<strong>自动调用</strong>，你只需在这些方法中编写响应事件的逻辑。事件源（哪个组件）和事件类型（点击、移动等）由事件对象携带。</li>
<li>这种方式更符合面向对象思想，代码组织更清晰，将事件处理逻辑与 UI 构建逻辑解耦。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>Windows窗口实现</strong></p>
<p>1.创建Windows应用程序，选择空项目</p>
<p>2.在新建窗口中选C++代码文件，创建一个新的cpp</p>
<p>3.在文件中添加：<code>#include &lt;Windows.h&gt;</code></p>
<p>添加<strong>入口函数</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">//#define CALLBACK	__stdcall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">CALLBACK</span> <span class="nf">WinMain</span><span class="p">(</span><span class="n">_In_</span> <span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">,</span>	<span class="c1">//当前实例句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                     <span class="n">_In_opt_</span> <span class="n">HINSTANCE</span> <span class="n">hPrevInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_</span> <span class="n">LPWSTR</span>    <span class="n">lpCmdLine</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_</span> <span class="kt">int</span>       <span class="n">nCmdShow</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>4.设计窗口类</p>
<p><code>WNDCLASS</code> 结构体的定义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tagWNDCLASS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">UINT</span>      <span class="n">style</span><span class="p">;</span>          <span class="c1">// 窗口类的样式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WNDPROC</span>   <span class="n">lpfnWndProc</span><span class="p">;</span>    <span class="c1">// 指向窗口过程函数的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span>       <span class="n">cbClsExtra</span><span class="p">;</span>     <span class="c1">// 附加的类内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span>       <span class="n">cbWndExtra</span><span class="p">;</span>     <span class="c1">// 附加的窗口内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">;</span>      <span class="c1">// 拥有该类的实例句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HICON</span>     <span class="n">hIcon</span><span class="p">;</span>          <span class="c1">// 类图标的句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HCURSOR</span>   <span class="n">hCursor</span><span class="p">;</span>        <span class="c1">// 类光标的句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HBRUSH</span>    <span class="n">hbrBackground</span><span class="p">;</span>  <span class="c1">// 类背景画刷的句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LPCTSTR</span>   <span class="n">lpszMenuName</span><span class="p">;</span>   <span class="c1">// 菜单资源的名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LPCTSTR</span>   <span class="n">lpszClassName</span><span class="p">;</span>  <span class="c1">// 窗口类的名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">WNDCLASS</span><span class="p">,</span> <span class="o">*</span><span class="n">PWNDCLASS</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/win32/%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png"
	width="1501"
	height="3210"
	srcset="/p/win32/%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B_hu_18ae02071916d6c6.png 480w, /p/win32/%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B_hu_a00cd30449fb73d7.png 1024w"
	loading="lazy"
	
		alt="消息处理流程"
	
	
		class="gallery-image" 
		data-flex-grow="46"
		data-flex-basis="112px"
	
></p>
<p>代码实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">LRESULT</span> <span class="n">CALLBACK</span> <span class="nf">WindowProc</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hwnd</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">);</span>	<span class="c1">//声明窗口过程函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">APIENTRY</span> <span class="nf">wWinMain</span><span class="p">(</span><span class="n">_In_</span> <span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_opt_</span> <span class="n">HINSTANCE</span> <span class="n">hPrevInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_</span> <span class="n">LPWSTR</span>    <span class="n">lpCmdLine</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_</span> <span class="kt">int</span>       <span class="n">nCmdShow</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//定义并注册窗口类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TCHAR</span> <span class="n">CLASS_NAME</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;MyFisrtWindowC&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WNDCLASS</span> <span class="n">wndclass</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>	<span class="c1">//若不初始化所有成员则无法创建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">wndclass</span><span class="p">.</span><span class="n">hbrBackground</span> <span class="o">=</span> <span class="p">(</span><span class="n">HBRUSH</span><span class="p">)</span><span class="n">COLOR_MENU</span><span class="p">;</span>    <span class="c1">//背景色
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">wndclass</span><span class="p">.</span><span class="n">lpfnWndProc</span> <span class="o">=</span> <span class="n">WindowProc</span><span class="p">;</span>  <span class="c1">//事件触发时由该函数处理(窗口过程函数)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">wndclass</span><span class="p">.</span><span class="n">lpszClassName</span> <span class="o">=</span> <span class="n">CLASS_NAME</span><span class="p">;</span> <span class="c1">//窗口类名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">wndclass</span><span class="p">.</span><span class="n">hInstance</span> <span class="o">=</span> <span class="n">hInstance</span><span class="p">;</span> <span class="c1">//当前窗口绑定的应用程序(当前实例)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">wndclass</span><span class="p">.</span><span class="n">hCursor</span> <span class="o">=</span> <span class="n">LoadCursor</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">IDC_ARROW</span><span class="p">);</span> <span class="c1">// 箭头光标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">RegisterClass</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wndclass</span><span class="p">);</span>  <span class="c1">//注册窗口类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">//创建窗口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HWND</span> <span class="n">hwnd</span> <span class="o">=</span> <span class="n">CreateWindowEx</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">,</span>                      <span class="c1">// 扩展样式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CLASS_NAME</span><span class="p">,</span>             <span class="c1">// 注册的类名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="sa">L</span><span class="s">&#34;我的Win32窗口&#34;</span><span class="p">,</span>        <span class="c1">// 窗口标题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">WS_OVERLAPPEDWINDOW</span><span class="p">,</span>    <span class="c1">// 窗口样式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 位置和大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CW_USEDEFAULT</span><span class="p">,</span> <span class="n">CW_USEDEFAULT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span><span class="p">,</span>       <span class="c1">// 父窗口句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>       <span class="c1">// 菜单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hInstance</span><span class="p">,</span>  <span class="c1">// 实例句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">NULL</span>        <span class="c1">// 附加数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hwnd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//显示窗口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ShowWindow</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="n">nCmdShow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">UpdateWindow</span><span class="p">(</span><span class="n">hwnd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//消息循环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MSG</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">GetMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TranslateMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">DispatchMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//实现窗口过程函数(回调函数)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">LRESULT</span> <span class="n">CALLBACK</span> <span class="nf">WindowProc</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">HWND</span> <span class="n">hwnd</span><span class="p">,</span>        <span class="c1">// 窗口句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UINT</span> <span class="n">uMsg</span><span class="p">,</span>        <span class="c1">// 消息类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span>    <span class="c1">// 附加信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span>    <span class="c1">// 附加信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">uMsg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_CREATE</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CREATESTRUCT</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">CREATESTRUCT</span><span class="o">*</span><span class="p">)</span><span class="n">lParam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//PrintDebugFormat(L&#34;WM_CREATE: %xh\nWM_CREATE: %s\n&#34;, uMsg, p-&gt;lpszClass);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_MOVE</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">short</span><span class="p">)</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">);</span>   <span class="c1">// horizontal position 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DWORD</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">short</span><span class="p">)</span><span class="n">HIWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">);</span>   <span class="c1">// vertical position
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//PrintDebugFormat(L&#34;WM_MOVE: %xh, x: %d, y: %d\n&#34;, uMsg, x, y);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_SIZE</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">short</span><span class="p">)</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">short</span><span class="p">)</span><span class="n">HIWORD</span><span class="p">(</span><span class="n">lParam</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//PrintDebugFormat(L&#34;WM_SIZE: %xh, size_v: %d, wide: %d, high: %d\n&#34;, uMsg, wParam, w, h);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 处理关闭消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nl">WM_DESTROY</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PrintDebugFormat</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;WM_DESTROY: %xh</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uMsg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">PostQuitMessage</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>  <span class="c1">// 退出消息循环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_KEYUP</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PrintDebugFormat</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;WM_KEYUP: %xh</span><span class="se">\t\t</span><span class="s">w l: %d %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_KEYDOWN</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PrintDebugFormat</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;WM_KEYDOWN: %xh</span><span class="se">\t</span><span class="s">w l: %d %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_LBUTTONDOWN</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PrintDebugFormat</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;WM_LBUTTONDOWN: %xh</span><span class="se">\t</span><span class="s">w l: %d %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 处理绘制消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nl">WM_PAINT</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PAINTSTRUCT</span> <span class="n">ps</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">HDC</span> <span class="n">hdc</span> <span class="o">=</span> <span class="n">BeginPaint</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 在此处绘制内容（例如文字）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">TextOut</span><span class="p">(</span><span class="n">hdc</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;Hello, Win32!&#34;</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">EndPaint</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 默认处理其他消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">DefWindowProc</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/win32/%E7%AA%97%E5%8F%A3%E5%AE%9E%E4%BE%8B.png"
	width="2308"
	height="1058"
	srcset="/p/win32/%E7%AA%97%E5%8F%A3%E5%AE%9E%E4%BE%8B_hu_a120035125e0e58a.png 480w, /p/win32/%E7%AA%97%E5%8F%A3%E5%AE%9E%E4%BE%8B_hu_db422a1158b01654.png 1024w"
	loading="lazy"
	
		alt="窗口实例"
	
	
		class="gallery-image" 
		data-flex-grow="218"
		data-flex-basis="523px"
	
></p>
<h4 id="定位回调函数">定位回调函数
</h4><p>参考<strong>定位入口程序</strong></p>
<p><code>WNDCLASS</code>结构体的<strong>第二个成员</strong>为回调函数地址，我们定位到<code>RegisterClass</code>函数，该函数传参为<code>wndclass</code>的地址，观察到<code>RegisterClass</code>函数前的<code>push</code>，此时的<strong>eax的值</strong>就是传入参数，我们跟随到堆栈，此时<code>eax+4</code>就是回调函数的地址</p>
<p><img src="/p/win32/wndclass%E5%9C%B0%E5%9D%80.png"
	width="2875"
	height="1530"
	srcset="/p/win32/wndclass%E5%9C%B0%E5%9D%80_hu_4aa3e17a767faf4f.png 480w, /p/win32/wndclass%E5%9C%B0%E5%9D%80_hu_73b5eab6400b36fa.png 1024w"
	loading="lazy"
	
		alt="wndclass地址"
	
	
		class="gallery-image" 
		data-flex-grow="187"
		data-flex-basis="450px"
	
></p>
<p>右键回调函数地址，转到反汇编，F2设断点，F9运行到断点，多按几次，此时程序会一直运行到该断点；然而，我们在该断点处右键编辑条件为**<code>[esp+8] == WM_LBUTTONDOWN</code><strong>，esp此时为回调函数的返回地址，<code>esp+8</code>自然为第二个参数</strong><code>uMsg</code>**，而<code>buttondown</code>是点击鼠标左键，程序再次运行后，<strong>只有当点击鼠标左键这一事件触发后</strong>，程序便又断在该断点</p>
<p><img src="/p/win32/%E6%96%AD%E7%82%B9%E8%AE%BE%E7%BD%AE%E6%9D%A1%E4%BB%B6.png"
	width="765"
	height="282"
	srcset="/p/win32/%E6%96%AD%E7%82%B9%E8%AE%BE%E7%BD%AE%E6%9D%A1%E4%BB%B6_hu_616a36af2441436f.png 480w, /p/win32/%E6%96%AD%E7%82%B9%E8%AE%BE%E7%BD%AE%E6%9D%A1%E4%BB%B6_hu_70660a56de02537e.png 1024w"
	loading="lazy"
	
		alt="断点设置条件"
	
	
		class="gallery-image" 
		data-flex-grow="271"
		data-flex-basis="651px"
	
></p>
<h4 id="子窗口">子窗口
</h4><p>创建子按钮窗口函数，这里的**实例句柄<code>hInst</code>**可用全局变量存储，在WinMain中给其赋值为当前实例<code>hInstance</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">CreateButton</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hwnd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HWND</span> <span class="n">hwndPushButton</span> <span class="o">=</span> <span class="n">CreateWindow</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;button&#34;</span><span class="p">),</span> <span class="c1">//系统定义的Button类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;普通按钮&#34;</span><span class="p">),</span>	<span class="c1">//按钮名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">WS_CHILD</span> <span class="o">|</span> <span class="n">WS_VISIBLE</span> <span class="o">|</span> <span class="n">BS_PUSHBUTTON</span> <span class="o">|</span> <span class="n">BS_DEFPUSHBUTTON</span><span class="p">,</span>	<span class="c1">//窗口样式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>		<span class="c1">//x, y
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="mi">80</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>		<span class="c1">//w, h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hwnd</span><span class="p">,</span>		<span class="c1">//父窗口句柄，这里是前面创建的窗口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">HMENU</span><span class="p">)</span><span class="mi">1001</span><span class="p">,</span>	<span class="c1">//子窗口ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hInst</span><span class="p">,</span>		<span class="c1">//实例句柄（当前WinMain句柄）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">NULL</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">TCHAR</span> <span class="n">szBuffer</span><span class="p">[</span><span class="mh">0x20</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">GetClassName</span><span class="p">(</span><span class="n">hwndPushButton</span><span class="p">,</span> <span class="n">szBuffer</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>	<span class="c1">//查看当前窗口句柄的类名，存在szBuffer中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WNDCLASS</span> <span class="n">wc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GetClassInfo</span><span class="p">(</span><span class="n">hInst</span><span class="p">,</span> <span class="n">szBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wc</span><span class="p">);</span>	<span class="c1">//得到当前窗口类地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PrintDebugFormat</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;--&gt;%s</span><span class="se">\n</span><span class="s">--&gt;%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">wc</span><span class="p">.</span><span class="n">lpszClassName</span><span class="p">,</span> <span class="n">wc</span><span class="p">.</span><span class="n">lpfnWndProc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">HWND</span> <span class="n">hwndCheckBox</span> <span class="o">=</span> <span class="n">CreateWindow</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;button&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;复选框&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">WS_CHILD</span> <span class="o">|</span> <span class="n">WS_VISIBLE</span> <span class="o">|</span> <span class="n">BS_CHECKBOX</span> <span class="o">|</span> <span class="n">BS_AUTOCHECKBOX</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">80</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">hwnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">HMENU</span><span class="p">)</span><span class="mi">1002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">hInst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">HWND</span> <span class="n">hwndRadio</span> <span class="o">=</span> <span class="n">CreateWindow</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;button&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;单选按钮&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">WS_CHILD</span> <span class="o">|</span> <span class="n">WS_VISIBLE</span> <span class="o">|</span> <span class="n">BS_RADIOBUTTON</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">10</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">80</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">hwnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">HMENU</span><span class="p">)</span><span class="mi">1003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">hInst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>子按钮窗口中，事件触发先会调用系统提供的WinProc，再转换成<code>WM_COMMAND</code>，接着调用父窗口WinProc，故在**父窗口<code>WindowProc</code>**中添加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">case</span> <span class="nl">WM_COMMAND</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">wParam</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">//LOWORD(wParam) -&gt; 子窗口ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="mi">1001</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">MessageBox</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;Button1&#34;</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;Demo&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">1002</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">MessageBox</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;Button2&#34;</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;Demo&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">1003</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">MessageBox</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;Button3&#34;</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;Demo&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="按钮事件逻辑定位">按钮事件逻辑定位
</h5><p>生成<code>Release x86</code>程序，<strong>定位回调函数</strong>，F2下断点</p>
<p><img src="/p/win32/%E5%AE%9A%E4%BD%8D%E7%AA%97%E5%8F%A3%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0.png"
	width="2870"
	height="1530"
	srcset="/p/win32/%E5%AE%9A%E4%BD%8D%E7%AA%97%E5%8F%A3%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0_hu_eef5c3cca97a3d82.png 480w, /p/win32/%E5%AE%9A%E4%BD%8D%E7%AA%97%E5%8F%A3%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0_hu_e5b4cd441f7ca1a0.png 1024w"
	loading="lazy"
	
		alt="定位窗口过程函数"
	
	
		class="gallery-image" 
		data-flex-grow="187"
		data-flex-basis="450px"
	
></p>
<p>此时，从栈顶往下的值依次是函数返回地址，<strong>窗口句柄<code>hwnd</code></strong>，<strong>消息类型<code>uMsg</code></strong>，<code>wParam</code>，<code>lParam</code>，按<code>W</code>可查看所有句柄</p>
<p><img src="/p/win32/%E6%9F%A5%E7%9C%8B%E5%8F%A5%E6%9F%84.png"
	width="1472"
	height="244"
	srcset="/p/win32/%E6%9F%A5%E7%9C%8B%E5%8F%A5%E6%9F%84_hu_89f84cb21cfd9740.png 480w, /p/win32/%E6%9F%A5%E7%9C%8B%E5%8F%A5%E6%9F%84_hu_58faa4bdaa1acb3d.png 1024w"
	loading="lazy"
	
		alt="查看句柄"
	
	
		class="gallery-image" 
		data-flex-grow="603"
		data-flex-basis="1447px"
	
></p>
<p>我们看到子窗口<code>“单选按钮”</code>ID为<code>0x3E8</code>，设置断点条件为**<code>[esp+8] == WM_COMMAND &amp;&amp; [esp+0xC] == 0x3EB</code><strong>，前一句代表消息类型为</strong>子窗口类型**，后一句代表子窗口ID为**“单选按钮”ID**</p>
<p><img src="/p/win32/%E6%96%AD%E7%82%B9%E8%AE%BE%E7%BD%AE%E6%9D%A1%E4%BB%B602.png"
	width="777"
	height="293"
	srcset="/p/win32/%E6%96%AD%E7%82%B9%E8%AE%BE%E7%BD%AE%E6%9D%A1%E4%BB%B602_hu_bf2b826a5380e8f2.png 480w, /p/win32/%E6%96%AD%E7%82%B9%E8%AE%BE%E7%BD%AE%E6%9D%A1%E4%BB%B602_hu_90e30d141ba84d75.png 1024w"
	loading="lazy"
	
		alt="断点设置条件02"
	
	
		class="gallery-image" 
		data-flex-grow="265"
		data-flex-basis="636px"
	
></p>
<p>程序运行后，只有点击<code>“单选按钮”</code>这个子窗口，程序才会再次停在该断点</p>
<h4 id="资源文件">资源文件
</h4><blockquote>
<p>在 Win32 应用程序中，资源文件（通常为 <code>.rc</code> 文件）用于定义对话框布局、图标、菜单等资源</p></blockquote>
<p>资源新建对话框<code>Dialog</code></p>
<p><img src="/p/win32/%E6%B7%BB%E5%8A%A0%E8%B5%84%E6%BA%90.png"
	width="1338"
	height="563"
	srcset="/p/win32/%E6%B7%BB%E5%8A%A0%E8%B5%84%E6%BA%90_hu_93e37a1d16c7da48.png 480w, /p/win32/%E6%B7%BB%E5%8A%A0%E8%B5%84%E6%BA%90_hu_4ee20a5e35905616.png 1024w"
	loading="lazy"
	
		alt="添加资源"
	
	
		class="gallery-image" 
		data-flex-grow="237"
		data-flex-basis="570px"
	
></p>
<p>左侧“工具箱”可以添加控件，右键可查看属性</p>
<p><img src="/p/win32/%E8%B5%84%E6%BA%90%E5%B1%9E%E6%80%A7.png"
	width="1804"
	height="982"
	srcset="/p/win32/%E8%B5%84%E6%BA%90%E5%B1%9E%E6%80%A7_hu_5596044cf0c8cd9c.png 480w, /p/win32/%E8%B5%84%E6%BA%90%E5%B1%9E%E6%80%A7_hu_c400d0774dc9239d.png 1024w"
	loading="lazy"
	
		alt="资源属性"
	
	
		class="gallery-image" 
		data-flex-grow="183"
		data-flex-basis="440px"
	
></p>
<p>（名称）不可更改（只能通过代码更改），身份ID</p>
<p><img src="/p/win32/%E5%AF%B9%E8%AF%9D%E6%A1%86%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png"
	width="2223"
	height="2085"
	srcset="/p/win32/%E5%AF%B9%E8%AF%9D%E6%A1%86%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F_hu_e1866f6e52445075.png 480w, /p/win32/%E5%AF%B9%E8%AF%9D%E6%A1%86%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F_hu_107bfa981a82c3e5.png 1024w"
	loading="lazy"
	
		alt="对话框生命周期"
	
	
		class="gallery-image" 
		data-flex-grow="106"
		data-flex-basis="255px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 对话框过程函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">INT_PTR</span> <span class="n">CALLBACK</span> <span class="nf">DialogProc</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hDlg</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">uMsg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 对话框初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nl">WM_INITDIALOG</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置对话框图标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">HICON</span> <span class="n">hIcon</span> <span class="o">=</span> <span class="n">LoadIcon</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">IDI_WIN32DIALOG</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">SendMessage</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">WM_SETICON</span><span class="p">,</span> <span class="n">ICON_BIG</span><span class="p">,</span> <span class="p">(</span><span class="n">LPARAM</span><span class="p">)</span><span class="n">hIcon</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化控件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SetDlgItemText</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDC_STATIC</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;欢迎使用 Win32 对话框&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置按钮文本
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SetDlgItemText</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDOK</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;确定(&amp;O)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">SetDlgItemText</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDCANCEL</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;取消(&amp;C)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置编辑框提示文本
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SetDlgItemText</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDC_EDIT_NAME</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;请输入姓名&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化进度条
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">HWND</span> <span class="n">hProgress</span> <span class="o">=</span> <span class="n">GetDlgItem</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDC_PROGRESS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//SendMessage(hProgress, PBM_SETRANGE, 0, MAKELPARAM(0, 100));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//SendMessage(hProgress, PBM_SETPOS, 50, 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                      <span class="c1">// 命令处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nl">WM_COMMAND</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">WORD</span> <span class="n">id</span> <span class="o">=</span> <span class="n">LOWORD</span><span class="p">(</span><span class="n">wParam</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">WORD</span> <span class="n">event</span> <span class="o">=</span> <span class="n">HIWORD</span><span class="p">(</span><span class="n">wParam</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 确定按钮
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">IDOK</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 获取编辑框内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">wchar_t</span> <span class="n">name</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">GetDlgItemText</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDC_EDIT_NAME</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ARRAYSIZE</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 显示消息框
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">wchar_t</span> <span class="n">message</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">swprintf</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">ARRAYSIZE</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="sa">L</span><span class="s">&#34;您好，%s！</span><span class="se">\n</span><span class="s">感谢使用本对话框&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">wcslen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nl">name</span> <span class="p">:</span> <span class="sa">L</span><span class="s">&#34;用户&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">MessageBox</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;问候&#34;</span><span class="p">,</span> <span class="n">MB_ICONINFORMATION</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 关闭对话框
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">EndDialog</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDOK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                 <span class="c1">// 取消按钮
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">IDCANCEL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">EndDialog</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDCANCEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                      <span class="c1">// 退出菜单项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">IDM_EXIT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">EndDialog</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDCANCEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                   <span class="c1">// 绘制对话框背景
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nl">WM_CTLCOLORDLG</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">static</span> <span class="n">HBRUSH</span> <span class="n">hBrush</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">hBrush</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">hBrush</span> <span class="o">=</span> <span class="n">CreateSolidBrush</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">255</span><span class="p">));</span> <span class="c1">// 浅蓝色背景
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="n">hBrush</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       <span class="c1">// 关闭对话框
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nl">WM_CLOSE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">EndDialog</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDCANCEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>WM_INITDIALOG</code> 是 Windows 对话框编程中一个非常重要的消息，用于对话框的初始化工作</p>
<p><strong>触发时机</strong>：</p>
<ul>
<li>在对话框被创建后，<strong>显示之前</strong>发送</li>
<li>当调用以下函数创建对话框时触发：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">DialogBox</span><span class="p">(),</span> <span class="n">DialogBoxParam</span><span class="p">(),</span> <span class="n">CreateDialog</span><span class="p">(),</span> <span class="n">CreateDialogParam</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>消息含义</strong>：</p>
<ul>
<li>通知对话框过程：对话框及其所有控件已创建完成</li>
<li>为开发者提供初始化对话框的机会</li>
</ul>
<p><strong>在此消息中应该做什么</strong></p>
<ol>
<li>
<p><strong>初始化控件</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SetDlgItemText(hwndDlg, IDC_EDIT1, L&#34;默认文本&#34;);
</span></span><span class="line"><span class="cl">CheckDlgButton(hwndDlg, IDC_CHECK1, BST_CHECKED);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>设置图标</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">HICON hIcon = LoadIcon(hInst, MAKEINTRESOURCE(IDI_APP_ICON));
</span></span><span class="line"><span class="cl">SendMessage(hwndDlg, WM_SETICON, ICON_BIG, (LPARAM)hIcon);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>设置默认焦点</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SetFocus(GetDlgItem(hwndDlg, IDC_EDIT1));
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>子类化控件</strong>（高级用法）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SetWindowLongPtr(GetDlgItem(hwndDlg, IDC_LIST1), GWLP_WNDPROC, 
</span></span><span class="line"><span class="cl">                (LONG_PTR)MyListProc);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>加载初始数据</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">LoadInitialData(hwndDlg);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="n">CALLBACK</span> <span class="nf">DialogProc</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">HWND</span> <span class="n">hwndDlg</span><span class="p">,</span>	<span class="c1">//handle to dialog box
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UINT</span> <span class="n">uMsg</span><span class="p">,</span>		<span class="c1">//message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span>	<span class="c1">//first message parameter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LPARAM</span> <span class="n">lParam</span>	<span class="c1">//second message parameter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">uMsg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_INITDIALOG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_COMMAND</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">wParam</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">IDOK</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//获取文本框的句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">HWND</span> <span class="n">hEditUser</span> <span class="o">=</span> <span class="n">GetDlgItem</span><span class="p">(</span><span class="n">hwndDlg</span><span class="p">,</span> <span class="n">IDC_EDIT1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">HWND</span> <span class="n">hEditPwd</span> <span class="o">=</span> <span class="n">GetDlgItem</span><span class="p">(</span><span class="n">hwndDlg</span><span class="p">,</span> <span class="n">IDC_EDIT2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//通过句柄得到内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">TCHAR</span> <span class="n">szUserBuffer</span><span class="p">[</span><span class="mh">0x50</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">TCHAR</span> <span class="n">szPwdBuffer</span><span class="p">[</span><span class="mh">0x50</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">GetWindowText</span><span class="p">(</span><span class="n">hEditUser</span><span class="p">,</span> <span class="n">szUserBuffer</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">GetWindowText</span><span class="p">(</span><span class="n">hEditPwd</span><span class="p">,</span> <span class="n">szPwdBuffer</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">IDCANCEL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">EndDialog</span><span class="p">(</span><span class="n">hwndDlg</span><span class="p">,</span> <span class="n">IDCANCEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_CLOSE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">EndDialog</span><span class="p">(</span><span class="n">hwndDlg</span><span class="p">,</span> <span class="n">IDCANCEL</span><span class="p">);</span>   <span class="c1">//关闭对话框
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建<code>Dialog</code>（主函数调用）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">DialogBox</span><span class="p">(</span><span class="n">hInstance</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">IDD_DIALOG1</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DialogProc</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>创建 Win32 项目</strong></p>
<ol>
<li>打开 Visual Studio，点击“创建新项目”。</li>
<li>选择 <strong>“Windows 桌面向导”</strong>（C++），点击“下一步”。</li>
<li>填写项目名称，点击“创建”。</li>
<li>在“配置新项目”界面，选择“Windows 应用程序”，点击“创建”</li>
</ol>
<p><strong>添加<code>Dialog</code>资源</strong></p>
<ol>
<li>在“解决方案资源管理器”中，右键点击“资源文件（.rc）”，选择“打开”。</li>
<li>在资源视图中，右键点击“Dialog”，选择“插入对话框”</li>
</ol>
<p><strong>编辑对话框</strong>（添加控件）</p>
<ol>
<li>双击新建的对话框（如 IDD_DIALOG1），进入<strong>对话框编辑器</strong>。</li>
<li>在左侧工具箱（Toolbox）中，可以拖拽以下控件到对话框上</li>
</ol>
<p>响应控件事件（按钮点击等）</p>
<ol>
<li>在对话框类的消息映射中添加响应函数。</li>
<li>以 Win32 API 为例，通常在对话框过程（DialogProc）中处理 <code>WM_COMMAND</code> 消息：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">INT_PTR</span> <span class="n">CALLBACK</span> <span class="nf">DialogProc</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hDlg</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">message</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_COMMAND</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">wParam</span><span class="p">)</span> <span class="o">==</span> <span class="n">IDC_BUTTON1</span><span class="p">)</span> <span class="c1">// 按钮ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">MessageBox</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;按钮被点击！&#34;</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;提示&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_CLOSE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">EndDialog</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>五、显示对话框</p>
<p>在主程序中调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">DialogBox</span><span class="p">(</span><span class="n">hInstance</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">IDD_DIALOG1</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DialogProc</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>六、添加图片资源</p>
<ol>
<li>在资源视图中，右键“资源”-&gt;“导入”，选择图片（如 BMP）。</li>
<li>在 Picture Control 的属性中，设置“Type”为 Bitmap，“Image”为刚导入的图片ID。</li>
</ol>
<h5 id="通过子类定位回调函数">通过子类定位回调函数
</h5><blockquote>
<p>即通过子窗口内置窗口过程函数定位父窗口回调函数WinProc</p></blockquote>
<p>以上述Release x86程序为例</p>
<p><code>x32dbg</code>打开，程序运行到<strong>弹出窗口</strong>后，点击“句柄”，右键-&gt;刷新，找到Button类，右键-&gt;<strong>消息断点</strong>设置<code>WM_LBUTTONUP</code>，等价于<code>[esp+8] == WM_LBUTTONUP</code>（消息类型为鼠标左键松开），此时<strong>点击窗口中的按钮</strong>，程序便会停在Button类的<strong>窗口过程函数</strong>了（在dll空间）</p>
<p><img src="/p/win32/%E6%B6%88%E6%81%AF%E6%96%AD%E7%82%B9.png"
	width="1884"
	height="882"
	srcset="/p/win32/%E6%B6%88%E6%81%AF%E6%96%AD%E7%82%B9_hu_bcfcf6b166c3357c.png 480w, /p/win32/%E6%B6%88%E6%81%AF%E6%96%AD%E7%82%B9_hu_a3f6b81549454988.png 1024w"
	loading="lazy"
	
		alt="消息断点"
	
	
		class="gallery-image" 
		data-flex-grow="213"
		data-flex-basis="512px"
	
></p>
<p>我们转到内存布局，选中“.text”段，右键-&gt;<strong>内存访问断点</strong>（程序访问内存时便会停下）</p>
<p><img src="/p/win32/%E5%86%85%E5%AD%98%E8%AE%BF%E9%97%AE%E6%96%AD%E7%82%B9.png"
	width="1615"
	height="809"
	srcset="/p/win32/%E5%86%85%E5%AD%98%E8%AE%BF%E9%97%AE%E6%96%AD%E7%82%B9_hu_85e24531929744b1.png 480w, /p/win32/%E5%86%85%E5%AD%98%E8%AE%BF%E9%97%AE%E6%96%AD%E7%82%B9_hu_6a28958e9fd9b6b6.png 1024w"
	loading="lazy"
	
		alt="内存访问断点"
	
	
		class="gallery-image" 
		data-flex-grow="199"
		data-flex-basis="479px"
	
></p>
<p>F9，此时的断点不一定是我们需要找的函数，因为可能在调用父窗口<code>WinProc</code>函数之前进行内存访问</p>
<p><img src="/p/win32/%E5%86%85%E5%AD%98%E6%96%AD%E7%82%B9.png"
	width="2880"
	height="1482"
	srcset="/p/win32/%E5%86%85%E5%AD%98%E6%96%AD%E7%82%B9_hu_d9822f5cf2f856b6.png 480w, /p/win32/%E5%86%85%E5%AD%98%E6%96%AD%E7%82%B9_hu_8cfca2b6bbec34ba.png 1024w"
	loading="lazy"
	
		alt="内存断点"
	
	
		class="gallery-image" 
		data-flex-grow="194"
		data-flex-basis="466px"
	
></p>
<p>继续F9，当<code>[esp+8] = 0x111</code>时，即<code>uMsg = WM_COMMAND</code>（<strong><code>WM_COMMAND</code>消息类型0x111</strong>，因为子类调用父类的回调函数时，消息类型变为<code>WM_COMMAND</code>，所以满足上述条件即为父类的<strong>窗口过程函数</strong>），定位成功</p>
<p><img src="/p/win32/%E7%AA%97%E5%8F%A3%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0.png"
	width="2880"
	height="1482"
	srcset="/p/win32/%E7%AA%97%E5%8F%A3%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0_hu_74d2ff0330c204d0.png 480w, /p/win32/%E7%AA%97%E5%8F%A3%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0_hu_e51a0c8ac3160ce3.png 1024w"
	loading="lazy"
	
		alt="窗口过程函数"
	
	
		class="gallery-image" 
		data-flex-grow="194"
		data-flex-basis="466px"
	
></p>
<h5 id="图标">图标
</h5><p>加载图标</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">HICON</span> <span class="n">hIcon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">hIcon</span> <span class="o">=</span> <span class="n">LoadIcon</span><span class="p">(</span><span class="n">hwndDlg</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">IDI_ICON1</span><span class="p">));</span>	<span class="c1">//句柄，图标编号
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>设置图标</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">case</span> <span class="nl">WM_INITDIALOG</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">HICON</span> <span class="n">hIcon</span> <span class="o">=</span> <span class="n">LoadIcon</span><span class="p">(</span><span class="n">hInst</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">IDI_ICON1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">SendMessage</span><span class="p">(</span><span class="n">hwndDlg</span><span class="p">,</span> <span class="n">WM_SETICON</span><span class="p">,</span> <span class="n">IDI_ICON1</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">hIcon</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="win32线程">Win32线程
</h2><blockquote>
<p>在 Windows 操作系统中，线程是程序执行的基本单元。理解 Win32 线程对于开发高效、响应迅速的 Windows 应用程序至关重要</p></blockquote>
<p>Win32 线程是 Windows 操作系统中最小的执行单元，具有以下特性：</p>
<ul>
<li><strong>轻量级进程</strong>：线程比进程更轻量，创建和切换开销小</li>
<li><strong>共享资源</strong>：同一进程内的线程共享内存空间和资源</li>
<li><strong>独立执行</strong>：每个线程有自己的程序计数器、寄存器集和堆栈</li>
<li><strong>并行执行</strong>：多核 CPU 上可真正并行运行</li>
</ul>
<blockquote>
<p><strong>线程生命周期</strong></p>
<ol>
<li><strong>创建</strong>：使用 <code>CreateThread()</code> 创建线程</li>
<li><strong>运行</strong>：线程执行其函数</li>
<li><strong>挂起</strong>：可暂停执行（<code>SuspendThread()</code>）</li>
<li><strong>恢复</strong>：继续执行（<code>ResumeThread()</code>）</li>
<li><strong>终止</strong>：线程函数返回或调用 <code>ExitThread()</code></li>
<li><strong>清理</strong>：关闭线程句柄（<code>CloseHandle()</code>）</li>
</ol></blockquote>
<h3 id="创建线程">创建线程
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="nf">CreateThread</span><span class="p">(</span>	<span class="c1">//返回值：线程句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">LPSECURITY_ATTRIBUTES</span>   <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="c1">// 安全属性（通常为 NULL）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">SIZE_T</span>                  <span class="n">dwStackSize</span><span class="p">,</span>        <span class="c1">// 堆栈大小（0=默认）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">LPTHREAD_START_ROUTINE</span>  <span class="n">lpStartAddress</span><span class="p">,</span>     <span class="c1">// 线程函数指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">LPVOID</span>                  <span class="n">lpParameter</span><span class="p">,</span>        <span class="c1">// 传递给线程的参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">DWORD</span>                   <span class="n">dwCreationFlags</span><span class="p">,</span>    <span class="c1">// 创建标志（0=立即运行）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">LPDWORD</span>                 <span class="n">lpThreadId</span>          <span class="c1">// 接收线程ID（可 NULL）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>线程函数签名</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">ThreadFunction</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpParam</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>等待线程结束</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">WaitForSingleObject</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">HANDLE</span> <span class="n">hHandle</span><span class="p">,</span>        <span class="c1">// 线程句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">DWORD</span>  <span class="n">dwMilliseconds</span>   <span class="c1">// 超时时间（INFINITE=无限等待）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>线程实现过程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">hThread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">ThreadFunction</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpParam</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 使用参数（可选）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">threadId</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="n">lpParam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Thread %d: +++++++++++++</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">threadId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">MyThread</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">threadId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span>		<span class="c1">//线程句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>           <span class="c1">// 安全属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="mi">0</span><span class="p">,</span>              <span class="c1">// 堆栈大小（默认）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ThreadFunction</span><span class="p">,</span> <span class="c1">// 线程函数指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">LPVOID</span><span class="p">)(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// 传递给线程的参数（这里也可以用全局变量传）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="mi">0</span><span class="p">,</span>              <span class="c1">// 创建标志（立即运行）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">&amp;</span><span class="n">threadId</span>       <span class="c1">// 接收线程ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;CreateThread failed! Error: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">GetLastError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MyThread</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 主线程工作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Main thread: -----------------</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 等待所有线程完成（实际项目中需要实现）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">hThread</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">::</span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>		<span class="c1">//若用&#34;::&#34;代表是全局函数，而不是类成员
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这里简单等待足够长时间让线程完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>与事件结合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;framework.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Win32线程窗口.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">HINSTANCE</span> <span class="n">hInst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">HWND</span> <span class="n">hEdit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">hThread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">Timer</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpParam</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TCHAR</span> <span class="n">szBuffer</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">GetWindowText</span><span class="p">(</span><span class="n">hEdit</span><span class="p">,</span> <span class="n">szBuffer</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span> <span class="c1">//获取文本框内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">dwTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">swscanf_s</span><span class="p">(</span><span class="n">szBuffer</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwTime</span><span class="p">);</span>    <span class="c1">//字符串转整数函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">dwTime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">memset</span><span class="p">(</span><span class="n">szBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">swprintf_s</span><span class="p">(</span><span class="n">szBuffer</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">--</span><span class="n">dwTime</span><span class="p">);</span>  <span class="c1">//整数转字符串函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SetWindowText</span><span class="p">(</span><span class="n">hEdit</span><span class="p">,</span> <span class="n">szBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">INT_PTR</span> <span class="n">CALLBACK</span> <span class="nf">DialogProc</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hDlg</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">message</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_INITDIALOG</span><span class="p">:</span> <span class="p">{</span>   <span class="c1">//初始化Dialog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hEdit</span> <span class="o">=</span> <span class="n">GetDlgItem</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDC_EDIT1</span><span class="p">);</span>    <span class="c1">//得到资源句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SetWindowText</span><span class="p">(</span><span class="n">hEdit</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;1000&#34;</span><span class="p">);</span>  <span class="c1">//设置文本框内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_COMMAND</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">wParam</span><span class="p">)</span> <span class="o">==</span> <span class="n">IDC_BUTTON1</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// 按钮ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//MessageBox(hDlg, L&#34;按钮被点击！&#34;, L&#34;提示&#34;, MB_OK);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Timer</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_CLOSE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">EndDialog</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">APIENTRY</span> <span class="nf">wWinMain</span><span class="p">(</span><span class="n">_In_</span> <span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_opt_</span> <span class="n">HINSTANCE</span> <span class="n">hPrevInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_</span> <span class="n">LPWSTR</span>    <span class="n">lpCmdLine</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_</span> <span class="kt">int</span>       <span class="n">nCmdShow</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DialogBox</span><span class="p">(</span><span class="n">hInstance</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">IDD_DIALOG1</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DialogProc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="线程控制函数">线程控制函数
</h4><p>Windows中的函数</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>功能</th>
          <th>函数名</th>
          <th>语法</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>线程创建函数</strong></td>
          <td><code>CreateThread()</code></td>
          <td>HANDLE CreateThread(<br/>  LPSECURITY_ATTRIBUTES   lpThreadAttributes,<br/>  SIZE_T                  dwStackSize,<br/>  LPTHREAD_START_ROUTINE  lpStartAddress,<br/>  LPVOID                  lpParameter,<br/>  DWORD                   dwCreationFlags,<br/>  LPDWORD                 lpThreadId<br/>);</td>
      </tr>
      <tr>
          <td><strong>线程终止函数</strong></td>
          <td><code>ExitThread()</code></td>
          <td>VOID ExitThread(DWORD dwExitCode);//在线程内部使用，参数为退出码，清除堆栈</td>
      </tr>
      <tr>
          <td><strong>强制终止线程</strong></td>
          <td><code>TerminateThread()</code></td>
          <td>BOOL TerminateThread(HANDLE hThread, DWORD dwExitCode);//不推荐</td>
      </tr>
      <tr>
          <td><strong>线程挂起函数</strong></td>
          <td><code>SuspendThread()</code></td>
          <td>DWORD SuspendThread(HANDLE hThread);</td>
      </tr>
      <tr>
          <td><strong>线程恢复函数</strong></td>
          <td><code>ResumeThread()</code></td>
          <td>DWORD ResumeThread(HANDLE hThread);</td>
      </tr>
      <tr>
          <td><strong>关闭线程句柄</strong></td>
          <td><code>CloseHandle()</code></td>
          <td>BOOL CloseHandle(HANDLE hObject);//不会终止线程</td>
      </tr>
      <tr>
          <td><strong>获取线程退出码</strong></td>
          <td><code>GetExitCodeThread()</code></td>
          <td>BOOL GetExitCodeThread(HANDLE hThread, LPDWORD lpExitCode);</td>
      </tr>
      <tr>
          <td><strong>获取线程伪句柄</strong></td>
          <td><code>GetCurrentThread()</code></td>
          <td>HANDLE GetCurrentThread(VOID);</td>
      </tr>
      <tr>
          <td><strong>获取线程ID</strong></td>
          <td><code>GetCurrentThreadId()</code></td>
          <td>DWORD GetCurrentThreadId(VOID);</td>
      </tr>
  </tbody>
</table></div>
<p>例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;framework.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Win32线程窗口.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">HINSTANCE</span> <span class="n">hInst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">HWND</span> <span class="n">hEdit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">hThread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">ThreadProc1</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpParam</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TCHAR</span> <span class="n">szBuffer</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">dwIndex</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//if (dwIndex == 10) ExitThread(2);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">GetWindowText</span><span class="p">(</span><span class="n">hEdit</span><span class="p">,</span> <span class="n">szBuffer</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">swscanf_s</span><span class="p">(</span><span class="n">szBuffer</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">memset</span><span class="p">(</span><span class="n">szBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">swprintf_s</span><span class="p">(</span><span class="n">szBuffer</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">++</span><span class="n">dwCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">SetWindowText</span><span class="p">(</span><span class="n">hEdit</span><span class="p">,</span> <span class="n">szBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">dwIndex</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">INT_PTR</span> <span class="n">CALLBACK</span> <span class="nf">DialogProc</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hDlg</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">message</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_INITDIALOG</span><span class="p">:</span> <span class="p">{</span>   <span class="c1">//初始化Dialog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hEdit</span> <span class="o">=</span> <span class="n">GetDlgItem</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="n">IDC_EDIT1</span><span class="p">);</span>    <span class="c1">//得到资源句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SetWindowText</span><span class="p">(</span><span class="n">hEdit</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;0&#34;</span><span class="p">);</span>  <span class="c1">//设置文本框内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_COMMAND</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">LOWORD</span><span class="p">(</span><span class="n">wParam</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">IDC_BUTTON1</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ThreadProc1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">IDC_BUTTON2</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SuspendThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>     <span class="c1">//挂起线程：不分配cpu
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">IDC_BUTTON3</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ResumeThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>      <span class="c1">//恢复线程：重新分配cpu
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">IDC_BUTTON4</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TerminateThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">WM_CLOSE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">EndDialog</span><span class="p">(</span><span class="n">hDlg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">INT_PTR</span><span class="p">)</span><span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">APIENTRY</span> <span class="nf">wWinMain</span><span class="p">(</span><span class="n">_In_</span> <span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_opt_</span> <span class="n">HINSTANCE</span> <span class="n">hPrevInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_</span> <span class="n">LPWSTR</span>    <span class="n">lpCmdLine</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">_In_</span> <span class="kt">int</span>       <span class="n">nCmdShow</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DialogBox</span><span class="p">(</span><span class="n">hInstance</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">IDD_DIALOG1</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DialogProc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="context">CONTEXT
</h4><blockquote>
<p>在 Windows 系统编程中，<code>CONTEXT</code> 是一个关键的数据结构，它用于<strong>表示处理器的状态</strong>。这个结构体包含了线程执行时 CPU 寄存器的完整快照，允许开发者在调试、异常处理或线程控制中检查和修改处理器的状态。</p></blockquote>
<p><code>CONTEXT</code> 结构体定义在 <code>&lt;winnt.h&gt;</code> 头文件中，其主要作用是：</p>
<ol>
<li><strong>保存和恢复线程状态</strong>：捕获线程执行时的完整寄存器状态</li>
<li><strong>异常处理</strong>：当发生异常时，系统提供 CONTEXT 结构显示异常发生时的状态</li>
<li><strong>调试器实现</strong>：调试器使用它来检查和控制被调试线程</li>
<li><strong>线程操作</strong>：挂起/恢复线程时保存状态</li>
</ol>
<p><strong>结构定义</strong>（x86 架构示例）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_CONTEXT</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">ContextFlags</span><span class="p">;</span>  <span class="c1">// 标志位，指定哪些寄存器有效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 调试寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">Dr0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Dr1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Dr2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Dr3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Dr6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Dr7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 浮点寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FLOATING_SAVE_AREA</span> <span class="n">FloatSave</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 段寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">SegGs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">SegFs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">SegEs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">SegDs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 通用寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">Edi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Esi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Ebx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Edx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Ecx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Eax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 控制寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">Ebp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">Eip</span><span class="p">;</span>      <span class="c1">// 指令指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">SegCs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">EFlags</span><span class="p">;</span>   <span class="c1">// 标志寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">Esp</span><span class="p">;</span>      <span class="c1">// 栈指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">SegSs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 扩展寄存器（如XMM等）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">BYTE</span> <span class="n">ExtendedRegisters</span><span class="p">[</span><span class="n">MAXIMUM_SUPPORTED_EXTENSION</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">CONTEXT</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ContextFlags 标志位</strong></p>
<p>这些标志指定要获取/设置哪些寄存器组：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">标志</th>
          <th style="text-align: left">含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><code>CONTEXT_CONTROL</code></td>
          <td style="text-align: left">控制寄存器 (Eip, Esp, Ebp, Eflags, SegCs, SegSs)</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>CONTEXT_INTEGER</code></td>
          <td style="text-align: left">整数寄存器 (Edi, Esi, Ebx, Edx, Ecx, Eax)</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>CONTEXT_SEGMENTS</code></td>
          <td style="text-align: left">段寄存器 (SegDs, SegEs, SegFs, SegGs)</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>CONTEXT_FLOATING_POINT</code></td>
          <td style="text-align: left">浮点寄存器</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>CONTEXT_DEBUG_REGISTERS</code></td>
          <td style="text-align: left">调试寄存器 (Dr0-Dr7)</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>CONTEXT_EXTENDED_REGISTERS</code></td>
          <td style="text-align: left">扩展寄存器 (XMM, MMX等)</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>CONTEXT_FULL</code></td>
          <td style="text-align: left">等价于 CONTROL + INTEGER + SEGMENTS</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>CONTEXT_ALL</code></td>
          <td style="text-align: left">所有可用寄存器</td>
      </tr>
  </tbody>
</table></div>
<h5 id="获取线程context结构">获取线程<code>CONTEXT</code>结构
</h5><ol>
<li>获取线程上下文</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="p">...;</span> <span class="c1">// 线程句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">CONTEXT</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">ctx</span><span class="p">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="n">CONTEXT_FULL</span><span class="p">;</span> <span class="c1">// 指定要获取的寄存器组
</span></span></span><span class="line"><span class="cl"><span class="c1">// 必须先挂起线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SuspendThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="n">GetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;当前EIP: 0x%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Eip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;当前ESP: 0x%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Esp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">ResumeThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>设置线程上下文</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">CONTEXT</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">ctx</span><span class="p">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="n">CONTEXT_CONTROL</span><span class="p">;</span> <span class="c1">// 只修改控制寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ctx</span><span class="p">.</span><span class="n">Eip</span> <span class="o">=</span> <span class="mh">0x00401000</span><span class="p">;</span> <span class="c1">// 设置新的指令指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ctx</span><span class="p">.</span><span class="n">Esp</span> <span class="o">=</span> <span class="mh">0x0012FF88</span><span class="p">;</span> <span class="c1">// 设置新的栈指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SuspendThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">SetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ResumeThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>异常处理</li>
</ol>
<p>在异常处理回调中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">LONG</span> <span class="n">WINAPI</span> <span class="nf">ExceptionHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">EXCEPTION_POINTERS</span><span class="o">*</span> <span class="n">pExceptionInfo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CONTEXT</span><span class="o">*</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">pExceptionInfo</span><span class="o">-&gt;</span><span class="n">ContextRecord</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;异常地址: 0x%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">Eip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 可以修改上下文，例如跳过导致异常的指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">Eip</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// 假设指令长度为2字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">EXCEPTION_CONTINUE_EXECUTION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>实例</p></blockquote>
<p>修改线程执行流</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">RedirectThread</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hThread</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">newAddress</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CONTEXT</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx</span><span class="p">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="n">CONTEXT_CONTROL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">SuspendThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">GetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ctx</span><span class="p">.</span><span class="n">Eip</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">newAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">SetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResumeThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>获取调用堆栈</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">PrintStackTrace</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hThread</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CONTEXT</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">ctx</span><span class="p">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="n">CONTEXT_CONTROL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SuspendThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">GetThreadContext</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">ebp</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Ebp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">eip</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Eip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Call stack:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">ebp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;  [%d] 0x%08X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">eip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 读取返回地址 (eip 在 ebp+4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="p">(</span><span class="n">LPCVOID</span><span class="p">)(</span><span class="n">ebp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">eip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eip</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 读取上一栈帧的 ebp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="p">(</span><span class="n">LPCVOID</span><span class="p">)</span><span class="n">ebp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ebp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ebp</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResumeThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="线程互斥与同步">线程互斥与同步
</h3><blockquote>
<p>在并发编程中（如Java），**线程互斥（Mutual Exclusion）<strong>和</strong>线程同步（Synchronization）**是确保多线程程序正确性的核心机制。它们解决了多线程环境下的共享资源访问问题，防止出现数据竞争和不确定行为</p></blockquote>
<h4 id="线程互斥">线程互斥
</h4><blockquote>
<ol>
<li>概念与目的</li>
</ol></blockquote>
<ul>
<li>
<p><strong>定义</strong>：确保<strong>同一时间只有一个线程可以访问共享资源</strong>（临界区）</p>
</li>
<li>
<p><strong>目的</strong>：防止<strong>数据竞争（Data Race）</strong> - 多个线程同时修改同一数据导致的不一致</p>
</li>
<li>
<p><strong>锁 (Lock)</strong>：这就是互斥机制的核心。在 Windows 中，最常用的锁是 <strong>互斥体 (Mutex)</strong> 和 <strong>临界区 (Critical Section)</strong></p>
</li>
<li>
<p>操作流程</p>
<ul>
<li><strong>进入临界区前，先尝试获取锁（锁门）</strong></li>
<li>如果锁是空闲的，那么这个线程就成功获取锁，然后进入临界区（进卫生间并锁上门）</li>
<li>如果锁已经被其他线程持有，那么这个线程就会<strong>被阻塞（在门口排队等待）</strong>，直到那个线程释放锁</li>
<li><strong>离开临界区后，必须释放锁（开门离开）</strong>，以便其他等待的线程可以获取它</li>
</ul>
</li>
</ul>
<p><strong>互斥是实现线程同步的基础</strong>，它是一种强制性的串行访问，保证了操作的原子性</p>
<blockquote>
<ol start="2">
<li>互斥实现机制</li>
</ol></blockquote>
<h5 id="互斥锁mutex">互斥锁Mutex
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;mutex&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span> <span class="c1">// 全局互斥锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">long</span> <span class="kt">long</span> <span class="n">shared_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">critical_section</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mtx</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>   <span class="c1">// 获取锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ... 访问共享资源 ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">shared_counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mtx</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span> <span class="c1">// 释放锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// RAII风格的更安全写法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">increment_safe</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span> <span class="c1">// 构造时自动加锁，析构时自动解锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">shared_counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="c1">// lock 变量在此处超出作用域，自动解锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">increment_safe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">(</span><span class="n">increment_safe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Final counter: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">shared_counter</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// 结果总是 200000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>特点</strong>：</p>
<ul>
<li>阻塞式：获取锁失败的线程会休眠</li>
<li>所有权：只有获取锁的线程能释放它</li>
<li>非递归：同一线程重复加锁会导致死锁（除非使用递归锁）</li>
</ul>
<p><strong>缺点</strong>：线程的挂起和唤醒涉及<strong>上下文切换</strong>，有较大的系统开销</p></blockquote>
<p>自旋锁（Spinlock）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;atomic&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">std</span><span class="o">::</span><span class="n">atomic_flag</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">ATOMIC_FLAG_INIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="kt">long</span> <span class="n">shared_counter_spin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">critical_section</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 忙等待循环，直到获取锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    	<span class="k">while</span> <span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="n">test_and_set</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">))</span> <span class="p">{}</span> <span class="c1">// 自旋等待
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ... 访问共享资源 ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    	<span class="n">shared_counter_spin</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    	<span class="n">lock</span><span class="p">.</span><span class="n">clear</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span> <span class="c1">// 释放锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">increment_spin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">(</span><span class="n">increment_spin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Final counter (spin lock): &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">shared_counter_spin</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>特点</strong>：</p>
<ul>
<li>忙等待：线程不会休眠，持续检查锁状态（<strong>忙等待<code>Busy-Waiting</code></strong>）</li>
<li>适用场景：<strong>临界区代码执行时间极短</strong>（&lt; 上下文切换时间）</li>
</ul>
<p><strong>缺点</strong>：如果锁被占用的时间较长，自旋锁会<strong>极度浪费CPU资源</strong></p></blockquote>
<h5 id="读写锁read-write-lock">读写锁Read-Write Lock
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;shared_mutex&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">std</span><span class="o">::</span><span class="n">shared_mutex</span> <span class="n">rw_mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 读操作（可并发）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">read_data</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">shared_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">rw_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... 只读访问 ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 写操作（独占）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">write_data</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">rw_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... 修改数据 ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Win32 API <code>SRWLock</code> (Slim Reader/Writer Lock) 代码示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">SRWLOCK</span> <span class="n">srw_lock</span><span class="p">;</span> <span class="c1">// 读写锁对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">shared_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">reader_thread</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AcquireSRWLockShared</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srw_lock</span><span class="p">);</span> <span class="c1">// 获取读锁（共享锁）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Reader &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; reads value: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">shared_value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ReleaseSRWLockShared</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srw_lock</span><span class="p">);</span> <span class="c1">// 释放读锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="c1">// 模拟其他工作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">writer_thread</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AcquireSRWLockExclusive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srw_lock</span><span class="p">);</span> <span class="c1">// 获取写锁（独占锁）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">shared_value</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Writer &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; incremented value to: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">shared_value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ReleaseSRWLockExclusive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srw_lock</span><span class="p">);</span> <span class="c1">// 释放写锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">InitializeSRWLock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srw_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">threads</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">writer_thread</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">threads</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">reader_thread</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">threads</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">reader_thread</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">threads</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">reader_thread</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">t</span> <span class="p">:</span> <span class="n">threads</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>特点</strong>：</p>
<ul>
<li>允许多个读线程并发访问</li>
<li>写操作需要独占访问</li>
<li>适用场景：读多写少的场景</li>
</ul>
<p><strong>缺点</strong>：实现比普通互斥锁复杂，可能会导致“写者饥饿”</p></blockquote>
<h5 id="临界区critical-section">临界区Critical Section
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">CRITICAL_SECTION</span> <span class="n">cs</span><span class="p">;</span>	<span class="c1">// 全局临界区对象
</span></span></span><span class="line"><span class="cl"><span class="c1">// 初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">InitializeCriticalSection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 进入临界区（阻塞）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">EnterCriticalSection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 尝试进入（非阻塞）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="n">TryEnterCriticalSection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_cs</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 成功进入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 其他线程持有锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 离开临界区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">LeaveCriticalSection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 删除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DeleteCriticalSection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Windows API 例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">CRITICAL_SECTION</span> <span class="n">g_cs</span><span class="p">;</span> <span class="c1">// 临界区对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">g_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">// 共享资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">ThreadFunc</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpParam</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">EnterCriticalSection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_cs</span><span class="p">);</span>   <span class="c1">// 进入临界区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 安全访问共享资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">g_counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">LeaveCriticalSection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_cs</span><span class="p">);</span>   <span class="c1">// 离开临界区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">InitializeCriticalSection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_cs</span><span class="p">);</span>  <span class="c1">// 初始化临界区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HANDLE</span> <span class="n">hThreads</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">hThreads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ThreadFunc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hThreads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ThreadFunc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">WaitForMultipleObjects</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">hThreads</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span> <span class="c1">// 等待线程结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DeleteCriticalSection</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_cs</span><span class="p">);</span>      <span class="c1">// 销毁临界区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Final counter value: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">g_counter</span><span class="p">);</span> <span class="c1">// 应为20000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="线程同步">线程同步
</h4><blockquote>
<ol>
<li>概念与目的</li>
</ol></blockquote>
<ul>
<li><strong>定义</strong>：协调线程间的执行顺序</li>
<li><strong>目的</strong>：确保线程按照特定顺序执行（如：生产者-消费者模式）</li>
<li><strong>事件</strong> (Event)：最常用的同步工具。一个线程可以等待一个事件被触发，另一个线程可以去触发这个事件
<ul>
<li><strong>自动重置事件</strong>：像一个旋转门，触发一次只能通过一个等待的线程，然后自动关闭。非常适合“一对一”的通知。</li>
<li><strong>手动重置事件</strong>：像一个水闸，一旦打开，所有等待的线程都可以通过，直到被手动关闭。适合“一对多”的广播通知。</li>
</ul>
</li>
<li><strong>信号量 (Semaphore)</strong>：一个带计数的锁。允许多个线程（不超过设定的最大数量）同时访问一个资源。就像一个有多把钥匙的房间，或者一个有固定车位的停车场。</li>
<li><strong>互斥体 (Mutex)</strong>：它本身既是互斥锁，也是一个内核同步对象。可以用于<strong>跨进程</strong>的线程同步，但效率比临界区低。</li>
<li><strong>条件变量 (Condition Variable)</strong>：通常与临界区或互斥锁配合使用，可以实现更复杂的等待/通知逻辑，避免CPU空转。</li>
</ul>
<blockquote>
<ol start="2">
<li>同步实现机制</li>
</ol></blockquote>
<p>条件变量（Condition Variable）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;condition_variable&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">cv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">data_ready</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 生产者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">producer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... 生产数据 ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">data_ready</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span> <span class="c1">// 通知消费者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 消费者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">consumer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="p">[]{</span> <span class="k">return</span> <span class="n">data_ready</span><span class="p">;</span> <span class="p">});</span> <span class="c1">// 等待条件满足
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ... 消费数据 ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">data_ready</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>工作原理</strong>：条件变量总是与一个<strong>互斥锁</strong>配合使用。它允许一个线程在某个<strong>条件不满足</strong>时，原子地<strong>释放锁并进入睡眠</strong>，直到另一个线程满足了该条件，并<strong>发送通知</strong>来唤醒它</p>
<p><strong>工作流程</strong>：</p>
<ol>
<li>消费者等待条件满足</li>
<li>生产者完成工作后通知消费者</li>
<li>消费者被唤醒并检查条件</li>
</ol></blockquote>
<blockquote>
<p><strong>特点</strong>：</p>
<ul>
<li>必须与互斥锁配合使用</li>
<li>解决&quot;等待-通知&quot;问题</li>
<li>防止忙等待</li>
</ul>
<p><strong>适用场景</strong>：需要等待某个复杂条件成立的生产者-消费者模型，或任何需要精细等待/通知的场景。可以避免使用 <code>Sleep</code> 的忙等待</p></blockquote>
<h5 id="信号量semaphore">信号量Semaphore
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;semaphore&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">std</span><span class="o">::</span><span class="n">counting_semaphore</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">sem</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// 最大10，初始0
</span></span></span><span class="line"><span class="cl"><span class="c1">// 生产者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">producer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... 生产项目 ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sem</span><span class="p">.</span><span class="n">release</span><span class="p">();</span> <span class="c1">// V操作：增加信号量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 消费者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">consumer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sem</span><span class="p">.</span><span class="n">acquire</span><span class="p">();</span> <span class="c1">// P操作：减少信号量（阻塞如果为0）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ... 消费项目 ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Win32 API  代码示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">HANDLE</span> <span class="n">hSemaphore</span><span class="p">;</span> <span class="c1">// 信号量句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">worker_thread</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Thread &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is waiting to enter the critical section.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 等待信号量，如果计数&gt;0则减一并进入，否则阻塞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hSemaphore</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Thread &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; has entered the critical section.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 模拟正在使用有限的资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Thread &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is leaving the critical section.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 释放信号量，计数加一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ReleaseSemaphore</span><span class="p">(</span><span class="n">hSemaphore</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int</span> <span class="n">MAX_CONCURRENT_THREADS</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int</span> <span class="n">TOTAL_THREADS</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建信号量，初始计数为3，最大计数为3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hSemaphore</span> <span class="o">=</span> <span class="n">CreateSemaphore</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">MAX_CONCURRENT_THREADS</span><span class="p">,</span> <span class="n">MAX_CONCURRENT_THREADS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hSemaphore</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TOTAL_THREADS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">threads</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">worker_thread</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">t</span> <span class="p">:</span> <span class="n">threads</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hSemaphore</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>工作原理</strong>：信号量维护一个<strong>非负整数计数</strong>，它有两个基本操作：</p>
<ul>
<li><strong>P操作（acquire/proberen）</strong>：减少信号量，如果&lt;0则阻塞</li>
<li><strong>V操作（release/verhogen）</strong>：增加信号量，唤醒等待线程</li>
</ul>
<p><strong>类型</strong>：</p>
<ul>
<li><strong>二进制信号量</strong>：值域{0,1}，类似互斥锁</li>
<li><strong>计数信号量</strong>：控制并发访问数量</li>
</ul>
<p><strong>适用场景</strong>：<strong>控制对有限资源的并发访问数量</strong>。例如，限制同时连接数据库的线程数，或限制线程池中同时工作的线程数</p>
<p><strong>注意</strong>：与互斥锁不同，信号量的 <code>wait</code> 和 <code>post</code> 操作可以由<strong>不同的线程</strong>执行</p></blockquote>
<h5 id="互斥体mutex">互斥体Mutex
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hMutex</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong><code>timeout</code> 参数设为 <code>0</code></strong> 是关键技巧。这意味着 <code>WaitForSingleObject</code> <strong>不会等待</strong>，它会立即检查锁的状态：</p>
<ul>
<li>如果锁可用，它就立即获取锁，并返回 <code>WAIT_OBJECT_0</code>。</li>
<li>如果锁不可用，它不会挂起线程去等待，而是立即返回 <code>WAIT_TIMEOUT</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 定义一个全局唯一的互斥体名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">mutexName</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;Global</span><span class="se">\\</span><span class="s">MyAppSingleInstanceMutex&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// &#34;Global\\&#34; 前缀确保在所有会话（包括远程桌面）中都唯一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HANDLE</span> <span class="n">hMutex</span> <span class="o">=</span> <span class="n">CreateMutex</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">TRUE</span><span class="p">,</span> <span class="c1">// 尝试成为初始所有者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">mutexName</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hMutex</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建失败，可能是权限问题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">MessageBox</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;无法创建互斥体!&#34;</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;错误&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 检查互斥体是否已经存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">GetLastError</span><span class="p">()</span> <span class="o">==</span> <span class="n">ERROR_ALREADY_EXISTS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 互斥体已存在，说明有另一个实例正在运行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">MessageBox</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;应用程序已经在运行了！&#34;</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;提示&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 必须关闭我们获取到的这个句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 退出当前实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果代码能执行到这里，说明这是第一个实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MessageBox</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;应用程序启动成功！&#34;</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;成功&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... 在这里运行你的主程序逻辑，比如消息循环 ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 程序退出前，释放并关闭互斥体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ReleaseMutex</span><span class="p">(</span><span class="n">hMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hMutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>工作原理</strong>：</p>
<ul>
<li><strong>等待 (Wait)</strong>：当一个线程尝试获取一个已经被占用的互斥体时（例如调用 <code>WaitForSingleObject</code>），操作系统会将这个线程置于<strong>等待状态</strong>并将其从调度队列中移除。这个线程会“睡眠”，不消耗CPU。</li>
<li><strong>唤醒 (Signal/Notify)</strong>：当持有互斥体的线程完成操作并释放它时（例如调用 <code>ReleaseMutex</code>），操作系统会检查是否有其他线程正在等待这个互斥体。如果有，操作系统会从等待队列中<strong>选择一个线程</strong>，将其状态从“等待”变为“就绪”，让它有机会获得互斥体并继续执行</li>
</ul>
<p><strong>特点</strong>：它本身既是互斥锁，也是一个内核同步对象。可以用于<strong>跨进程</strong>的线程同步，但效率比临界区低。</p></blockquote>
<h5 id="事件event">事件Event
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Windows API 示例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">HANDLE</span> <span class="n">hEvent</span> <span class="o">=</span> <span class="n">CreateEvent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 设置事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SetEvent</span><span class="p">(</span><span class="n">hEvent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 等待事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hEvent</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 设置事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SetEvent</span><span class="p">(</span><span class="n">hEvent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">CloseHandle</span><span class="p">(</span><span class="n">hEvent</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>特点</strong>：</p>
<ul>
<li>状态机制：有信号/无信号</li>
<li>线程等待事件被触发</li>
<li>手动重置 vs 自动重置事件</li>
</ul>
<p><strong>与互斥体的对比</strong>：</p>
<ul>
<li><strong>事件</strong>的“等待-唤醒”是<strong>显式</strong>的。你需要在一个线程中明确调用 <code>SetEvent</code> 来唤醒另一个正在<code>WaitForSingleObject</code> 的线程。</li>
<li><strong>互斥体</strong>的“等待-唤醒”是<strong>隐式</strong>的。它的唤醒操作与<code>ReleaseMutex</code> 绑定在一起，你无法单独触发唤醒而不释放锁</li>
</ul></blockquote>
<h5 id="生产者-消费者">生产者-消费者
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// 共享的“信箱”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="n">g_mailbox</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">g_dataReady</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 同步对象：一个事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">HANDLE</span> <span class="n">g_hEvent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 生产者线程：负责准备数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">ProducerThread</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpParam</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Producer: Preparing data...&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span> <span class="c1">// 模拟耗时的数据准备工作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">strcpy_s</span><span class="p">(</span><span class="n">g_mailbox</span><span class="p">,</span> <span class="s">&#34;Hello from the producer!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">g_dataReady</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Producer: Data is ready. Signaling the event.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 数据准备好了，触发事件，通知消费者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SetEvent</span><span class="p">(</span><span class="n">g_hEvent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 消费者线程：负责使用数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">ConsumerThread</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpParam</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Consumer: Waiting for data...&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 等待事件被触发，最多等待5秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">g_hEvent</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 一旦被唤醒，就知道数据已经准备好了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">g_dataReady</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Consumer: Received data: </span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">g_mailbox</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Consumer: Timed out. No data received.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建一个自动重置、初始未触发的事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">g_hEvent</span> <span class="o">=</span> <span class="n">CreateEvent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hProducer</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ProducerThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hConsumer</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ConsumerThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hProducer</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hConsumer</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProducer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hConsumer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">g_hEvent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="互斥与同步对比">互斥与同步对比
</h4><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">特性</th>
          <th style="text-align: left">线程互斥</th>
          <th style="text-align: left">线程同步</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>主要目的</strong></td>
          <td style="text-align: left">保护共享资源</td>
          <td style="text-align: left">协调线程执行顺序</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>核心问题</strong></td>
          <td style="text-align: left">数据竞争</td>
          <td style="text-align: left">执行顺序依赖</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>典型场景</strong></td>
          <td style="text-align: left">共享数据修改</td>
          <td style="text-align: left">生产者-消费者</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>实现机制</strong></td>
          <td style="text-align: left">互斥锁、自旋锁</td>
          <td style="text-align: left">条件变量、信号量</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>资源访问</strong></td>
          <td style="text-align: left">独占访问</td>
          <td style="text-align: left">协作访问</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>性能影响</strong></td>
          <td style="text-align: left">上下文切换开销</td>
          <td style="text-align: left">线程阻塞开销</td>
      </tr>
  </tbody>
</table></div>
<p><strong>参考</strong></p>
<p><a class="link" href="https://gh0st.cn/Binary-Learning/Win32.html"  target="_blank" rel="noopener"
    >Win32 - 滴水逆向课程笔记</a></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E9%9D%99%E6%80%81/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/">
        
        
            <div class="article-image">
                <img src="/p/%E9%9D%99%E6%80%81/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/%E7%93%B7%E5%BF%83%E5%82%80%E5%84%A1.a01753e234e91b5b60d15e20f6ab3d39_hu_da4ff1af95136a83.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 静态/动态链接库"
                        
                        data-hash="md5-oBdT4jTpG1tg0V4g9qs9OQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">静态/动态链接库</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/">
        
        
            <div class="article-image">
                <img src="/p/pe%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/%E6%AF%8D%E7%A5%9E%E5%82%A9.1cbfec7fd9f434b2e7ce94c863f98c71_hu_5bf0474e753d4b86.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post PE文件结构"
                        
                        data-hash="md5-HL/sf9n0NLLnzpTIY/mMcQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">PE文件结构</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E6%B1%87%E7%BC%96/">
        
        
            <div class="article-image">
                <img src="/p/%E6%B1%87%E7%BC%96/%E8%9C%98%E8%9B%9B.0a867634743b3823929b7c4bcb69cd3c_hu_a28985ae574a8cb4.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 汇编"
                        
                        data-hash="md5-CoZ2NHQ7OCOSm3xLy2nNPA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">汇编</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 liuhuaqing
    </section>
    
    <section class="powerby">
        
            人生若只如初见 <br/>
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
